<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analysis scripts: longitudinal ESBL carriage dynamics • blantyreESBL</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Analysis scripts: longitudinal ESBL carriage dynamics">
<meta property="og:description" content="blantyreESBL">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">blantyreESBL</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/analysis-ecoli.html">Analysis scripts: E. coli genomics</a>
    </li>
    <li>
      <a href="../articles/analysis-kleb.html">Analysis scripts: K. pneumoniae complex genomics</a>
    </li>
    <li>
      <a href="../articles/analysis.html">Analysis scripts: longitudinal ESBL carriage dynamics</a>
    </li>
    <li>
      <a href="../articles/fitting-stan-models.html">Fitting and simulating from Stan models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="analysis_files/header-attrs-2.10/header-attrs.js"></script><script src="analysis_files/kePrint-0.0.1/kePrint.js"></script><link href="analysis_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Analysis scripts: longitudinal ESBL carriage dynamics</h1>
            
      
      
      <div class="hidden name"><code>analysis.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This document contains reproducing analysis code which generates the tables and figures for the manuscript:</p>
<p><br></p>
<p><em>Dynamics of gut mucosal colonisation with extended spectrum beta-lactamase producing Enterobacterales in Malawi</em></p>
<p><br></p>
<p>Joseph M Lewis<sup>1,2,3,4</sup>, , Madalitso Mphasa<sup>1</sup>, Rachel Banda<sup>1</sup>, Matthew Beale<sup>4</sup>, Eva Heinz<sup>2</sup>, Jane Mallewa<sup>5</sup>, Christopher Jewell<sup>6</sup>, Nicholas R Thomson<sup>4,7</sup>, Nicholas A Feasey<sup>1,2</sup></p>
<ol style="list-style-type: decimal">
<li>Malawi Liverpool Wellcome Clinical Research Programme, Blantyre, Malawi</li>
<li>Liverpool School of Tropical Medicine, Liverpool, UK</li>
<li>Department of Clinical Infection, Microbiology and Immunology, University of Liverpool, Liverpool, UK</li>
<li>Wellcome Sanger Institute, Hinxton, UK</li>
<li>College of Medicine, University of Malawi, Malawi</li>
<li>University of Lancaster, Lanaster, UK</li>
<li>London School of Tropical Medicine and Hygiene, London, UK</li>
</ol>
<div id="installing-and-accessing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-and-accessing-data" class="anchor"></a>Installing and accessing data</h3>
<p>If you just want the data, then all the data to replicate the analysis are bundled with the package. To install the package from GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"devtools"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"https://github.com/joelewis101/blantyreESBL)</span></span></code></pre></div>
<p>The various data objects are described in the <a href="https://joelewis101.github.io/blantyreESBL/">pkgdown</a> site for this package, and available via R in the usual way (i.e. <code><a href="../reference/btESBL_participants.html">?btESBL_participants</a></code> brings up the definitions for the <code>btESBL_participants</code> data. They are all lazy loaded so will be available for use immediately; they all start with <code>btESBL_</code> to make it easy to choose the one you want using autocomplete.</p>
<p>The analysis is available as a package vignette; this can be built when downloading the package by typing:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"https://github.com/joelewis101/blantyreESBL"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></code></pre></div>
<p>The <code>dependencies = TRUE</code> option will install all the packages necessary to run the vignettes.</p>
<p>Alternatively the source code for the vignette is <code>analysis.Rmd</code> in the <code>vignettes/</code> folder of the <a href="https://github.com/joelewis101/blantyreESBL">GitHub</a> repo or the <a href="https://joelewis101.github.io/blantyreESBL/">pkgdown</a> site for this package has a rendered version.</p>
</div>
<div id="setup-load-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#setup-load-packages" class="anchor"></a>Setup, load packages</h3>
</div>
<div id="baseline-characteristics" class="section level3">
<h3 class="hasAnchor">
<a href="#baseline-characteristics" class="anchor"></a>Baseline characteristics</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#library(blantyreESBL)</span>

<span class="va">btESBL_participants</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>unprotected_water_source <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">watersource</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Unprotected well/spring"</span>, 
                       <span class="st">"Surface water (including rainwater collection)"</span><span class="op">)</span> <span class="op">~</span>
      <span class="st">"Yes"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"No"</span><span class="op">)</span>,
    toilet <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">toilet</span> <span class="op">==</span> <span class="st">"Flush Toliet (any type)"</span> <span class="op">~</span> <span class="st">"Flush toilet"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Latrine or no toilet"</span><span class="op">)</span>,
    watersource <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">watersource</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Unprotected well/spring"</span>,
                         <span class="st">"Surface water (including rainwater collection)"</span><span class="op">)</span> <span class="op">~</span>
        <span class="st">"Unprotected"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Protected"</span><span class="op">)</span>,
    keep.other <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">keepanim</span> <span class="op">==</span> <span class="st">"No"</span> <span class="op">~</span> <span class="cn">NA_character_</span>,
      <span class="va">keep.cattle</span> <span class="op">==</span> <span class="st">"Yes"</span> <span class="op">~</span> <span class="st">"Yes"</span>,
      <span class="va">keep.mules</span> <span class="op">==</span> <span class="st">"Yes"</span> <span class="op">~</span> <span class="st">"Yes"</span>,
      <span class="va">keep.sheep</span> <span class="op">==</span> <span class="st">"Yes"</span> <span class="op">~</span> <span class="st">"Yes"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"No"</span><span class="op">)</span>,
    tbongoing <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tbongoing</span><span class="op">)</span>, <span class="st">"No"</span>, <span class="va">tbongoing</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">arm</span>,
      <span class="va">calc_age</span>,
      <span class="va">ptsex</span>,
      <span class="va">hivstatus</span>,
      <span class="va">tbongoing</span>,
      <span class="va">hivonart</span>,
      <span class="va">art_time</span>,
      <span class="va">hivart</span>,
      <span class="va">hivcpt</span>,
      <span class="va">recieved_prehosp_ab</span>,
      <span class="va">pmhxrechospital</span>,
      <span class="va">toilet</span>,
      <span class="va">watersource</span>,
      <span class="va">watertreated</span>,
      <span class="va">householdchildno</span>,
      <span class="va">housholdadultsno</span>,
      <span class="va">electricityyn</span>,
      <span class="va">keepanim</span>,
      <span class="va">keep.poultry</span>,
      <span class="va">keep.dogs</span>,
      <span class="va">keep.goats</span>,
      <span class="va">keep.other</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">t1.data</span>

<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>

  <span class="va">t1.data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_if</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">arm</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
      names_from <span class="op">=</span> <span class="va">arm</span>,
      values_from <span class="op">=</span> <span class="va">n</span>,
      values_fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu">map</span><span class="op">(</span>
      <span class="va">data</span>,
      <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.x</span>, <span class="op">-</span><span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span>simulate.p.value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">p.value</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      str1 <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">'{`1`}/{sum(`1`)} ({specify_decimal(`1`*100/sum(`1`), 0)}%)'</span><span class="op">)</span>,
      str2 <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">'{`2`}/{sum(`2`)} ({specify_decimal(`2`*100/sum(`2`), 0)}%)'</span><span class="op">)</span>,
      str3 <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">'{`3`}/{sum(`3`)} ({specify_decimal(`3`*100/sum(`3`), 0)}%)'</span><span class="op">)</span>,
      str_tot <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span>
        <span class="st">'{`1` + `2` + `3`}/{sum(`1`) + sum(`2`) + sum(`3`)} ({specify_decimal((`1` + `2` + `3`)*100/(sum(`1`) + sum(`2`) + sum(`3`)), 0)}%)'</span>
      <span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">!=</span> <span class="st">"No"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">value</span>, <span class="va">str_tot</span>, <span class="va">str1</span>, <span class="va">str2</span>, <span class="va">str3</span>, <span class="va">p.value</span><span class="op">)</span>,
  
  <span class="va">t1.data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"arm"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kruskal.test.html">kruskal.test</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">arm</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span>,
      median.t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">value</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      lqr.t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      uqr.t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      Total <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span>
        <span class="st">'{specify_decimal(median.t,1)} ({specify_decimal(lqr.t,1)}-{specify_decimal(uqr.t,1)})'</span>
      <span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">value</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      lqr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      uqr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
      strz <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span>
        <span class="st">'{specify_decimal(median,1)} ({specify_decimal(lqr,1)}-{specify_decimal(uqr,1)})'</span>
      <span class="op">)</span>,
      p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>,
      Total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Total</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">arm</span>, <span class="va">strz</span>, <span class="va">p</span>, <span class="va">Total</span><span class="op">)</span>  <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"str"</span>, <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
      id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">p</span>, <span class="va">Total</span><span class="op">)</span>,
      names_from <span class="op">=</span> <span class="va">arm</span>,
      values_from <span class="op">=</span> <span class="va">strz</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>p.value <span class="op">=</span> <span class="va">p</span>,
           str_tot <span class="op">=</span> <span class="va">Total</span><span class="op">)</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="va">name</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">t1</span>
<span class="co">#&gt; `summarise()` has grouped output by 'name'. You can override using the `.groups` argument.</span>

<span class="va">t1</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">value</span> <span class="op">!=</span> <span class="st">"Unprotected"</span>,
    <span class="va">value</span> <span class="op">!=</span> <span class="st">"Latrine or no toilet"</span>,
    <span class="va">value</span> <span class="op">!=</span> <span class="st">"Female"</span>,
    <span class="va">value</span> <span class="op">!=</span> <span class="st">"ART regimen: other"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"hivstatus"</span>, 
                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"HIV "</span>,<span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>, <span class="va">value</span><span class="op">)</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">name</span> <span class="op">==</span> <span class="st">"householdchildno"</span> <span class="op">~</span> <span class="st">"Number of children"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"housholdadultsno"</span> <span class="op">~</span> <span class="st">"Number of adults"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"calc_age"</span> <span class="op">~</span> <span class="st">"Age (yr)"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"art_time"</span> <span class="op">~</span> <span class="st">"Months on ART"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"hivonart"</span><span class="op">~</span> <span class="st">"Current ART"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"hivcpt"</span> <span class="op">~</span> <span class="st">"Current CPT"</span>,
      <span class="va">value</span> <span class="op">==</span> <span class="st">"5A"</span> <span class="op">~</span> <span class="st">"ART regimen: EFV/3TC/TDF"</span>,
      <span class="co"># name == "tbstatus" ~ "Ever treated for TB",</span>
      <span class="va">name</span> <span class="op">==</span> <span class="st">"tbongoing"</span> <span class="op">~</span> <span class="st">"Current TB treatment"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"recieved_prehosp_ab"</span> <span class="op">~</span> <span class="st">"Antibiotics within 28 days&lt;sup&gt;&amp;dagger;&lt;/sup&gt;"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"pmhxrechospital"</span> <span class="op">~</span> <span class="st">"Hospitalised within 28 days"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"watertreated"</span> <span class="op">~</span> <span class="st">"Treat drinking water with chlorine"</span>,
      <span class="va">value</span> <span class="op">==</span> <span class="st">"Protected"</span> <span class="op">~</span> <span class="st">"Protected water source&lt;sup&gt;&amp;sect;&lt;/sup&gt;"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"keepanim"</span> <span class="op">~</span> <span class="st">"Keep animals"</span>,
      <span class="va">name</span> <span class="op">==</span> <span class="st">"electricityyn"</span> <span class="op">~</span> <span class="st">"Electricty in house"</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"keep"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"keep\\."</span>,<span class="st">""</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span>,
      <span class="va">value</span> <span class="op">==</span> <span class="st">"Flush toilet"</span> <span class="op">~</span> <span class="st">"Flush toilet&lt;sup&gt;&amp;Dagger;&lt;/sup&gt;"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">value</span><span class="op">)</span>,
    <span class="co"># ---</span>
    name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"keep\\."</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|</span> 
        <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"householdchildno"</span>, <span class="st">"housholdadultsno"</span>,
                   <span class="st">"keepanim"</span>, <span class="st">"electricityyn"</span><span class="op">)</span>  <span class="op">~</span>  <span class="st">"Household"</span>,
      <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"calc_age"</span>, <span class="st">"ptsex"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Demographics"</span>,
      <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hivstatus"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"HIV status"</span>, 
      <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tbstatus"</span>, <span class="st">"tbongoing"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Healthcare exposure"</span>, 
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"art"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"cpt"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ART status*"</span>, 
      <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"recieved_prehosp_ab"</span>, <span class="st">"pmhxrechospital"</span>, <span class="st">"tbongoing"</span><span class="op">)</span> <span class="op">~</span> 
        <span class="st">"Healthcare exposure"</span>,
      <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"toilet"</span>, <span class="st">"watertreated"</span>, <span class="st">"watersource"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Household"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">name</span>
     <span class="op">)</span>,
    <span class="co"># ---</span>
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
      <span class="va">name</span>,
      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"Demographics"</span>,
        <span class="st">"HIV status"</span>,
        <span class="st">"ART status*"</span>,
        <span class="st">"Healthcare exposure"</span>,
        <span class="st">"Household"</span>
        <span class="op">)</span><span class="op">)</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
      <span class="va">value</span>, 
      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"Age (yr)"</span>,
        <span class="st">"Male"</span>,
        <span class="st">"HIV Reactive"</span>,
        <span class="st">"Current CPT"</span>,
        <span class="st">"Current ART"</span>,
        <span class="st">"ART regimen: EFV/3TC/TDF"</span>,
        <span class="st">"Months on ART"</span>,
        <span class="st">"HIV Non Reactive"</span>,
        <span class="st">"HIV Unknown"</span>,
        <span class="st">"Antibiotics within 28 days&lt;sup&gt;&amp;dagger;&lt;/sup&gt;"</span>,
        <span class="st">"Hospitalised within 28 days"</span>,
        <span class="st">"Current TB treatment"</span>,
        <span class="st">"Number of adults"</span>,
        <span class="st">"Number of children"</span>,
        <span class="st">"Keep animals"</span>,
        <span class="st">"Poultry"</span>,
        <span class="st">"Dogs"</span>,
        <span class="st">"Goats"</span>,
        <span class="st">"Other"</span>,
        <span class="st">"Electricty in house"</span>,
        <span class="st">"Flush toilet&lt;sup&gt;&amp;Dagger;&lt;/sup&gt;"</span>,
        <span class="st">"Protected water source&lt;sup&gt;&amp;sect;&lt;/sup&gt;"</span>,
        <span class="st">"Treat drinking water with chlorine"</span>
      <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">t1</span>

<span class="va">t1</span> <span class="op">%&gt;%</span>  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p.value <span class="op">=</span> <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">p.value</span>,<span class="fl">3</span><span class="op">)</span>,
         p.value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">==</span> <span class="st">"0.000"</span>, <span class="st">"&lt;0.001"</span>, <span class="va">p.value</span><span class="op">)</span>,
         p.value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
           <span class="va">value</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HIV Non Reactive"</span>, 
                        <span class="st">"HIV Unknown"</span>,
                        <span class="st">"Poultry"</span>,
                        <span class="st">"Dogs"</span>,
                        <span class="st">"Goats"</span>,
                        <span class="st">"Other"</span><span class="op">)</span> <span class="op">~</span> <span class="st">""</span>,
           <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">p.value</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">t1</span>



 <span class="va">t1</span> <span class="op">%&gt;%</span> 
   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span>, .drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">groupvar</span>
 
 <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">groupvar</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">t1</span><span class="op">$</span><span class="va">name</span><span class="op">)</span>
 <span class="va">indentrows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">t1</span><span class="op">$</span><span class="va">value</span> <span class="op">%in%</span> 
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Poultry"</span>,
                        <span class="st">"Dogs"</span>,
                        <span class="st">"Goats"</span>,
                        <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span>
  

<span class="va">t1</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">str1</span>, <span class="va">str2</span>, <span class="va">str3</span>, <span class="va">p.value</span>,<span class="va">str_tot</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span><span class="op">(</span>col.names <span class="op">=</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
          <span class="st">"Variable"</span>,
          <span class="st">"Sepsis (n=225)"</span>,
          <span class="st">"Inpatient (n=100)"</span>,
          <span class="st">"Community (n=100)"</span>,
          <span class="st">"p"</span>,
          <span class="st">"Total (n = 425)"</span>
        <span class="op">)</span>, 
      escape <span class="op">=</span> <span class="cn">FALSE</span>,
      caption <span class="op">=</span> <span class="st">"Baseline characteristics of included participants"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_classic</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">groupvar</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="va">indentrows</span>, italic <span class="op">=</span> <span class="cn">TRUE</span>  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/footnote.html">footnote</a></span><span class="op">(</span>
    general <span class="op">=</span> <span class="st">"ART = Antiretroviral therapy, CPT = Cotrimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric variables are summarised as median (IQR) and categorical variables as proportions. P-values are from Fisher's exact test (categorical variables) or Kruskal-Wallace test (continuous variables) across the three groups; p-value for HIV status compares distribution of HIV reactive, non-reactive and unknown across the three groups. In smoe cases denominator may be less than the total number of participants due to missing data."</span>,
    symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"Denominator for ART status is HIV reactive participants only"</span>,
      <span class="st">"Excluding TB treatment and CPT"</span>,
      <span class="st">"Flush toilet vs latrine (pit or hanging) or no toilet"</span>,
      <span class="st">"Protected water source includes borehole, water piped into or outside dwelling or public standpipe; unprotected sources include surface water or unprotected springs."</span>
    <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<table class="table  lightable-classic">
<caption>
Baseline characteristics of included participants
</caption>
<thead><tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Sepsis (n=225)
</th>
<th style="text-align:left;">
Inpatient (n=100)
</th>
<th style="text-align:left;">
Community (n=100)
</th>
<th style="text-align:left;">
p
</th>
<th style="text-align:left;">
Total (n = 425)
</th>
</tr></thead>
<tbody>
<tr grouplength="2">
<td colspan="6" style="border-bottom: 0;">
<strong>Demographics</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Age (yr)
</td>
<td style="text-align:left;">
35.9 (27.8-43.5)
</td>
<td style="text-align:left;">
40.4 (29.1-48.3)
</td>
<td style="text-align:left;">
32.5 (24.0-38.4)
</td>
<td style="text-align:left;">
&lt;0.001
</td>
<td style="text-align:left;">
35.6 (26.9-43.9)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Male
</td>
<td style="text-align:left;">
114/225 (51%)
</td>
<td style="text-align:left;">
51/100 (51%)
</td>
<td style="text-align:left;">
40/100 (40%)
</td>
<td style="text-align:left;">
0.156
</td>
<td style="text-align:left;">
205/425 (48%)
</td>
</tr>
<tr grouplength="3">
<td colspan="6" style="border-bottom: 0;">
<strong>HIV status</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
HIV Reactive
</td>
<td style="text-align:left;">
143/225 (64%)
</td>
<td style="text-align:left;">
12/100 (12%)
</td>
<td style="text-align:left;">
18/100 (18%)
</td>
<td style="text-align:left;">
&lt;0.001
</td>
<td style="text-align:left;">
173/425 (41%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
HIV Non Reactive
</td>
<td style="text-align:left;">
70/225 (31%)
</td>
<td style="text-align:left;">
77/100 (77%)
</td>
<td style="text-align:left;">
22/100 (22%)
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
169/425 (40%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
HIV Unknown
</td>
<td style="text-align:left;">
12/225 (5%)
</td>
<td style="text-align:left;">
11/100 (11%)
</td>
<td style="text-align:left;">
60/100 (60%)
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
83/425 (20%)
</td>
</tr>
<tr grouplength="4">
<td colspan="6" style="border-bottom: 0;">
<strong>ART status*</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Current CPT
</td>
<td style="text-align:left;">
98/141 (70%)
</td>
<td style="text-align:left;">
5/12 (42%)
</td>
<td style="text-align:left;">
7/18 (39%)
</td>
<td style="text-align:left;">
0.016
</td>
<td style="text-align:left;">
110/171 (64%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Current ART
</td>
<td style="text-align:left;">
117/143 (82%)
</td>
<td style="text-align:left;">
9/12 (75%)
</td>
<td style="text-align:left;">
18/18 (100%)
</td>
<td style="text-align:left;">
0.076
</td>
<td style="text-align:left;">
144/173 (83%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
ART regimen: EFV/3TC/TDF
</td>
<td style="text-align:left;">
110/117 (94%)
</td>
<td style="text-align:left;">
8/9 (89%)
</td>
<td style="text-align:left;">
17/18 (94%)
</td>
<td style="text-align:left;">
0.648
</td>
<td style="text-align:left;">
135/144 (94%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Months on ART
</td>
<td style="text-align:left;">
28.7 (3.7-72.6)
</td>
<td style="text-align:left;">
35.1 (2.9-79.8)
</td>
<td style="text-align:left;">
31.5 (13.0-79.9)
</td>
<td style="text-align:left;">
0.698
</td>
<td style="text-align:left;">
29.5 (3.8-72.8)
</td>
</tr>
<tr grouplength="3">
<td colspan="6" style="border-bottom: 0;">
<strong>Healthcare exposure</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Antibiotics within 28 days<sup>†</sup>
</td>
<td style="text-align:left;">
60/225 (27%)
</td>
<td style="text-align:left;">
0/100 (0%)
</td>
<td style="text-align:left;">
0/100 (0%)
</td>
<td style="text-align:left;">
&lt;0.001
</td>
<td style="text-align:left;">
60/425 (14%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hospitalised within 28 days
</td>
<td style="text-align:left;">
18/225 (8%)
</td>
<td style="text-align:left;">
1/100 (1%)
</td>
<td style="text-align:left;">
0/100 (0%)
</td>
<td style="text-align:left;">
0.001
</td>
<td style="text-align:left;">
19/425 (4%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Current TB treatment
</td>
<td style="text-align:left;">
10/225 (4%)
</td>
<td style="text-align:left;">
0/100 (0%)
</td>
<td style="text-align:left;">
4/100 (4%)
</td>
<td style="text-align:left;">
0.089
</td>
<td style="text-align:left;">
14/425 (3%)
</td>
</tr>
<tr grouplength="11">
<td colspan="6" style="border-bottom: 0;">
<strong>Household</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Number of adults
</td>
<td style="text-align:left;">
2.0 (2.0-3.0)
</td>
<td style="text-align:left;">
3.0 (2.0-4.0)
</td>
<td style="text-align:left;">
2.0 (2.0-4.0)
</td>
<td style="text-align:left;">
0.907
</td>
<td style="text-align:left;">
3.0 (2.0-4.0)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Number of children
</td>
<td style="text-align:left;">
2.0 (1.0-3.0)
</td>
<td style="text-align:left;">
2.0 (1.0-3.0)
</td>
<td style="text-align:left;">
2.0 (1.0-3.0)
</td>
<td style="text-align:left;">
0.395
</td>
<td style="text-align:left;">
2.0 (1.0-3.0)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Keep animals
</td>
<td style="text-align:left;">
71/225 (32%)
</td>
<td style="text-align:left;">
43/100 (43%)
</td>
<td style="text-align:left;">
15/100 (15%)
</td>
<td style="text-align:left;">
&lt;0.001
</td>
<td style="text-align:left;">
129/425 (30%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;font-style: italic;" indentlevel="1">
Poultry
</td>
<td style="text-align:left;font-style: italic;">
46/71 (65%)
</td>
<td style="text-align:left;font-style: italic;">
34/43 (79%)
</td>
<td style="text-align:left;font-style: italic;">
10/15 (67%)
</td>
<td style="text-align:left;font-style: italic;">
</td>
<td style="text-align:left;font-style: italic;">
90/129 (70%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;font-style: italic;" indentlevel="1">
Dogs
</td>
<td style="text-align:left;font-style: italic;">
18/71 (25%)
</td>
<td style="text-align:left;font-style: italic;">
11/43 (26%)
</td>
<td style="text-align:left;font-style: italic;">
9/15 (60%)
</td>
<td style="text-align:left;font-style: italic;">
</td>
<td style="text-align:left;font-style: italic;">
38/129 (29%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;font-style: italic;" indentlevel="1">
Goats
</td>
<td style="text-align:left;font-style: italic;">
12/71 (17%)
</td>
<td style="text-align:left;font-style: italic;">
7/43 (16%)
</td>
<td style="text-align:left;font-style: italic;">
1/15 (7%)
</td>
<td style="text-align:left;font-style: italic;">
</td>
<td style="text-align:left;font-style: italic;">
20/129 (16%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;font-style: italic;" indentlevel="1">
Other
</td>
<td style="text-align:left;font-style: italic;">
3/71 (4%)
</td>
<td style="text-align:left;font-style: italic;">
6/43 (14%)
</td>
<td style="text-align:left;font-style: italic;">
0/15 (0%)
</td>
<td style="text-align:left;font-style: italic;">
</td>
<td style="text-align:left;font-style: italic;">
9/129 (7%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Electricty in house
</td>
<td style="text-align:left;">
119/225 (53%)
</td>
<td style="text-align:left;">
41/100 (41%)
</td>
<td style="text-align:left;">
58/100 (58%)
</td>
<td style="text-align:left;">
0.037
</td>
<td style="text-align:left;">
218/425 (51%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Flush toilet<sup>‡</sup>
</td>
<td style="text-align:left;">
14/225 (6%)
</td>
<td style="text-align:left;">
5/100 (5%)
</td>
<td style="text-align:left;">
1/100 (1%)
</td>
<td style="text-align:left;">
0.114
</td>
<td style="text-align:left;">
20/425 (5%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Protected water source<sup>§</sup>
</td>
<td style="text-align:left;">
216/225 (96%)
</td>
<td style="text-align:left;">
92/100 (92%)
</td>
<td style="text-align:left;">
98/100 (98%)
</td>
<td style="text-align:left;">
0.111
</td>
<td style="text-align:left;">
406/425 (96%)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Treat drinking water with chlorine
</td>
<td style="text-align:left;">
19/225 (8%)
</td>
<td style="text-align:left;">
5/100 (5%)
</td>
<td style="text-align:left;">
0/100 (0%)
</td>
<td style="text-align:left;">
0.003
</td>
<td style="text-align:left;">
24/425 (6%)
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> ART = Antiretroviral therapy, CPT = Cotrimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric variables are summarised as median (IQR) and categorical variables as proportions. P-values are from Fisher’s exact test (categorical variables) or Kruskal-Wallace test (continuous variables) across the three groups; p-value for HIV status compares distribution of HIV reactive, non-reactive and unknown across the three groups. In smoe cases denominator may be less than the total number of participants due to missing data.
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup>*</sup> Denominator for ART status is HIV reactive participants only
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup>†</sup> Excluding TB treatment and CPT
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup>‡</sup> Flush toilet vs latrine (pit or hanging) or no toilet
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup>§</sup> Protected water source includes borehole, water piped into or outside dwelling or public standpipe; unprotected sources include surface water or unprotected springs.
</td>
</tr>
</tfoot>
</table>
</div>
<div id="exposures" class="section level3">
<h3 class="hasAnchor">
<a href="#exposures" class="anchor"></a>Exposures</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Amoxicillin"</span> <span class="op">=</span> <span class="st">"amoxy"</span>,
  <span class="st">"Gentamicin"</span> <span class="op">=</span> <span class="st">"genta"</span>,
  <span class="st">"Azithromycin"</span> <span class="op">=</span> <span class="st">"azithro"</span>,
  <span class="st">"TB therapy"</span> <span class="op">=</span> <span class="st">"tb"</span>,
  <span class="st">"Penicillin"</span> <span class="op">=</span> <span class="st">"benzy"</span>,
  <span class="st">"Fluconazole"</span> <span class="op">=</span> <span class="st">"fluco"</span>,
  <span class="st">"Ceftriaxone"</span> <span class="op">=</span> <span class="st">"cefo"</span>,
  <span class="st">"Amphotericin"</span> <span class="op">=</span> <span class="st">"ampho"</span>,
  <span class="st">"Quinine"</span> <span class="op">=</span> <span class="st">"quin"</span>,
  <span class="st">"Chloramphenicol"</span> <span class="op">=</span> <span class="st">"chlora"</span>,
  <span class="st">"LA"</span> <span class="op">=</span> <span class="st">"coart"</span>,
  <span class="st">"Ciprofloxacin"</span> <span class="op">=</span> <span class="st">"cipro"</span>,
  <span class="st">"Co-amoxiclav"</span> <span class="op">=</span> <span class="st">"coamo"</span>,
  <span class="st">"Artesunate"</span> <span class="op">=</span> <span class="st">"arte"</span>,
  <span class="st">"Cotrimoxazole"</span> <span class="op">=</span> <span class="st">"cotri"</span>,
  <span class="st">"Clindamycin"</span> <span class="op">=</span> <span class="st">"clinda"</span>,
  <span class="st">"Doxycycline"</span> <span class="op">=</span> <span class="st">"doxy"</span>,
  <span class="st">"Erythromycin"</span> <span class="op">=</span> <span class="st">"erythro"</span>,
  <span class="st">"Aciclovir"</span> <span class="op">=</span> <span class="st">"acicl"</span>,
  <span class="st">"Flucloxacillin"</span> <span class="op">=</span> <span class="st">"fluclox"</span>,
  <span class="st">"Metronidazole"</span> <span class="op">=</span> <span class="st">"metro"</span>,
  <span class="st">"Streptomycin"</span> <span class="op">=</span> <span class="st">"strepto"</span>,
  <span class="st">"Hospitalised"</span> <span class="op">=</span> <span class="st">"hosp"</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">rename_lookup</span>



<span class="va">btESBL_exposures</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span>assess_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">assess_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">rename_lookup</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_participants</span>, <span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Sepsis"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Inpatient"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Community"</span><span class="op">)</span>,
    arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">arm</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepsis"</span>, <span class="st">"Inpatient"</span>, <span class="st">"Community"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">died</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#filter(arm != 3) %&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">assess_type</span>, <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">assess_type</span>, <span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, prop <span class="op">=</span> <span class="va">x</span><span class="op">/</span><span class="va">n</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"Amoxicillin"</span>,
      <span class="st">"Ceftriaxone"</span>,
      <span class="st">"Ciprofloxacin"</span>,
      <span class="st">"Cotrimoxazole"</span>,
      <span class="st">"Hospitalised"</span>,
      <span class="st">"TB therapy"</span>,
      <span class="st">"Hospitalised"</span>
    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>   
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">assess_type</span>,<span class="va">prop</span>, group <span class="op">=</span> <span class="va">name</span>, color <span class="op">=</span> <span class="va">name</span>, linetype <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">arm</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span>,<span class="fl">10</span>,<span class="fl">15</span>,<span class="fl">20</span>,<span class="fl">25</span>,<span class="fl">30</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Amoxicillin"</span> <span class="op">=</span>  <span class="st">"solid"</span>,
                                   <span class="st">"Ceftriaxone"</span> <span class="op">=</span> <span class="st">"solid"</span>,
                                   <span class="st">"Ciprofloxacin"</span> <span class="op">=</span> <span class="st">"solid"</span>,
                                   <span class="st">"Cotrimoxazole"</span> <span class="op">=</span> <span class="st">"solid"</span>,
                                   <span class="st">"Hospitalised"</span> <span class="op">=</span> <span class="st">"dashed"</span>,
                                   <span class="st">"TB therapy"</span> <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span>,
                        breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Hospitalised"</span>,
                                   <span class="st">"Ceftriaxone"</span>,
                                   <span class="st">"Cotrimoxazole"</span>,
                                   <span class="st">"Ciprofloxacin"</span>,
                                   <span class="st">"TB therapy"</span>,
                                   <span class="st">"Amoxicillin"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Amoxicillin"</span> <span class="op">=</span>  <span class="fu">pal_npg</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
                                 <span class="st">"Ceftriaxone"</span> <span class="op">=</span> <span class="fu">pal_npg</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,
                                 <span class="st">"Ciprofloxacin"</span> <span class="op">=</span> <span class="fu">pal_npg</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,
                                 <span class="st">"Cotrimoxazole"</span> <span class="op">=</span> <span class="fu">pal_npg</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,
                                 <span class="st">"Hospitalised"</span> <span class="op">=</span> <span class="st">"black"</span>,
                                 <span class="st">"TB therapy"</span> <span class="op">=</span> <span class="st">"grey20"</span><span class="op">)</span>,
                      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Hospitalised"</span>,
                                   <span class="st">"Ceftriaxone"</span>,
                                   <span class="st">"Cotrimoxazole"</span>,
                                   <span class="st">"Ciprofloxacin"</span>, 
                                   <span class="st">"TB therapy"</span>,
                                   <span class="st">"Amoxicillin"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Day post enrolment"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Proportion"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">exp_plot</span>
<span class="co">#&gt; Joining, by = "pid"</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm', 'assess_type'. You can override using the `.groups` argument.</span>

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_exposures.pdf"</span><span class="op">)</span>,<span class="va">exp_plot</span>,width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_exposures.svg"</span><span class="op">)</span>,<span class="va">exp_plot</span>,width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">exp_plot</span>
<span class="co">#&gt; Warning: Removed 3042 row(s) containing missing values (geom_path).</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/exp-1.png" alt="Exposures during study period. Panels show proportion of participants in each arm of the study who are hospitalised of exposed to antimicrobials on a given day" width="768"><p class="caption">
Exposures during study period. Panels show proportion of participants in each arm of the study who are hospitalised of exposed to antimicrobials on a given day
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="va">btESBL_exposures</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span>assess_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">assess_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">rename_lookup</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_participants</span>, <span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">assess_type</span>, <span class="va">died</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="st">'Total at risk'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">name</span>, <span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>pid.exp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    n.p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span><span class="op">)</span>,
    exposure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pid.exp</span><span class="op">)</span>,
    median.exp.len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">pid.exp</span><span class="op">)</span>,
    lq.exp.len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pid.exp</span>, <span class="fl">0.25</span><span class="op">)</span>,
    uq.exp.len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pid.exp</span>, <span class="fl">0.75</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    exp.len.str <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">median.exp.len</span>, <span class="fl">0</span><span class="op">)</span>,
      <span class="st">"("</span>,
      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">lq.exp.len</span>, <span class="fl">0</span><span class="op">)</span>,
      <span class="st">"-"</span>,
      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">uq.exp.len</span>, <span class="fl">0</span><span class="op">)</span>,
      <span class="st">")"</span>
    <span class="op">)</span>,
    exposure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">exposure</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">arm</span>, <span class="va">n.p</span>, <span class="va">exposure</span>, <span class="va">exp.len.str</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    exp.len.str <span class="op">=</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"Total"</span> <span class="op">~</span> <span class="st">"-"</span>,
                <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">exp.len.str</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">arm</span>,
    values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n.p</span>, <span class="va">exposure</span>, <span class="va">exp.len.str</span><span class="op">)</span>,
    values_fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      n.p <span class="op">=</span> <span class="fl">0</span>,
      exposure <span class="op">=</span> <span class="st">"0"</span>,
      exp.len.str <span class="op">=</span> <span class="st">"-"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n.p_1</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
    col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Exposure"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepsis"</span>, <span class="st">"Inpatient"</span>, <span class="st">"Community"</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
    caption <span class="op">=</span> <span class="st">"Antimicrobial and hospital exposure stratified by arm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_classic</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#row_spec(1, bold = TRUE) %&gt;% </span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Exposures"</span>, <span class="fl">2</span>, <span class="fl">23</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/add_header_above.html">add_header_above</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" "</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Number exposed"</span> <span class="op">=</span> <span class="fl">3</span>, <span class="st">"Exposure (person-days)"</span> <span class="op">=</span> <span class="fl">3</span>,
                     <span class="st">"Median (IQR) exposure length (days)"</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/footnote.html">footnote</a></span><span class="op">(</span>general <span class="op">=</span> <span class="st">"TB = tuberculosis, LA =lumefantrine artemether. Median exposure length includes only those exposed. Total at risk shows the total number of participants and participant-days of follow up included in the study."</span><span class="op">)</span> 
<span class="co">#&gt; Joining, by = "pid"</span>
<span class="co">#&gt; `summarise()` has grouped output by 'pid', 'name'. You can override using the `.groups` argument.</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm'. You can override using the `.groups` argument.</span></code></pre></div>
<table class="table  lightable-classic">
<caption>
Antimicrobial and hospital exposure stratified by arm
</caption>
<thead>
<tr>
<th style="empty-cells: hide;" colspan="1">
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Number exposed
</div>
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Exposure (person-days)
</div>
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Median (IQR) exposure length (days)
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
Exposure
</th>
<th style="text-align:right;">
Sepsis
</th>
<th style="text-align:right;">
Inpatient
</th>
<th style="text-align:right;">
Community
</th>
<th style="text-align:left;">
Sepsis
</th>
<th style="text-align:left;">
Inpatient
</th>
<th style="text-align:left;">
Community
</th>
<th style="text-align:left;">
Sepsis
</th>
<th style="text-align:left;">
Inpatient
</th>
<th style="text-align:left;">
Community
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Total at risk
</td>
<td style="text-align:right;">
225
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:left;">
33797
</td>
<td style="text-align:left;">
14336
</td>
<td style="text-align:left;">
21983
</td>
<td style="text-align:left;">
183(63-203)
</td>
<td style="text-align:left;">
182(97-187)
</td>
<td style="text-align:left;">
200(185-219)
</td>
</tr>
<tr grouplength="22">
<td colspan="10" style="border-bottom: 0;">
<strong>Exposures</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hospitalised
</td>
<td style="text-align:right;">
225
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
1727
</td>
<td style="text-align:left;">
500
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
5(2-10)
</td>
<td style="text-align:left;">
2(2-7)
</td>
<td style="text-align:left;">
1(1-1)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Ceftriaxone
</td>
<td style="text-align:right;">
183
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
997
</td>
<td style="text-align:left;">
26
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
5(3-7)
</td>
<td style="text-align:left;">
3(2-4)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Cotrimoxazole
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:left;">
14447
</td>
<td style="text-align:left;">
549
</td>
<td style="text-align:left;">
1388
</td>
<td style="text-align:left;">
180(27-190)
</td>
<td style="text-align:left;">
86(6-177)
</td>
<td style="text-align:left;">
190(183-206)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Ciprofloxacin
</td>
<td style="text-align:right;">
61
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
398
</td>
<td style="text-align:left;">
12
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
7(5-7)
</td>
<td style="text-align:left;">
6(6-6)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
TB therapy
</td>
<td style="text-align:right;">
52
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
6843
</td>
<td style="text-align:left;">
291
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
178(58-180)
</td>
<td style="text-align:left;">
146(133-158)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Amoxicillin
</td>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
235
</td>
<td style="text-align:left;">
21
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
7(5-7)
</td>
<td style="text-align:left;">
5(5-8)
</td>
<td style="text-align:left;">
5(5-5)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Fluconazole
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
118
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
3(2-5)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Metronidazole
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
148
</td>
<td style="text-align:left;">
10
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
6(2-7)
</td>
<td style="text-align:left;">
5(5-5)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Artesunate
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
25
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
2(2-3)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Co-amoxiclav
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
40
</td>
<td style="text-align:left;">
12
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
5(2-5)
</td>
<td style="text-align:left;">
6(6-6)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
LA
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
19
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
3(2-3)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Doxycycline
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
34
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
3(2-6)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Erythromycin
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
38
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
7(5-11)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Gentamicin
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
15
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
4(3-5)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Streptomycin
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
16
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
8(7-9)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Penicillin
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
2(2-3)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Flucloxacillin
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
2(2-3)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Azithromycin
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
12
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
4(3-4)
</td>
<td style="text-align:left;">
6(6-6)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Amphotericin
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
4(4-4)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Aciclovir
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
47
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
24(16-31)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Quinine
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
1(1-1)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Chloramphenicol
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
0
</td>
<td style="text-align:left;">
1(1-1)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> TB = tuberculosis, LA =lumefantrine artemether. Median exposure length includes only those exposed. Total at risk shows the total number of participants and participant-days of follow up included in the study.
</td>
</tr>
</tfoot>
</table>
</div>
<div id="timing-of-sample-collection" class="section level3">
<h3 class="hasAnchor">
<a href="#timing-of-sample-collection" class="anchor"></a>Timing of sample collection</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">visit</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>visit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Visit "</span>, <span class="va">visit</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">visit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">60</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">visit</span>,
  scale <span class="op">=</span> <span class="st">'free_y'</span>,
  ncol <span class="op">=</span> <span class="fl">1</span>,
  strip.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time post enrolment (days)"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samp_col_dates</span>

<span class="va">samp_col_dates</span>
<span class="co">#&gt; Warning: Removed 7 rows containing non-finite values (stat_bin).</span>
<span class="co">#&gt; Warning: Removed 8 rows containing missing values (geom_bar).</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/sample_timing-1.png" alt="Timing of sample collection showing long tails around sample collection time." width="576"><p class="caption">
Timing of sample collection showing long tails around sample collection time.
</p>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_sample_collection_dates.pdf"</span><span class="op">)</span>,
         <span class="va">samp_col_dates</span>,
         width <span class="op">=</span> <span class="fl">6</span>,
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_sample_collection_dates.svg"</span><span class="op">)</span>,
         <span class="va">samp_col_dates</span>,
         width <span class="op">=</span> <span class="fl">4</span>, 
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="species-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#species-plot" class="anchor"></a>Species plot</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">btESBL_stoolorgs</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    organism <span class="op">=</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">organism</span> <span class="op">==</span> <span class="st">"pantoea sp"</span> <span class="op">~</span> <span class="st">"Panotea species"</span>,
                <span class="va">organism</span> <span class="op">==</span> <span class="st">"Gram negative bacilli"</span> <span class="op">~</span>
                  <span class="st">"Gram negative bacilli*"</span>,
                <span class="va">organism</span> <span class="op">==</span> <span class="st">"Klebsiella pneumoniae"</span> <span class="op">~</span>
                  <span class="st">"Klebsiella pneumoniae complex"</span>,
                <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">organism</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">ESBL</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"n"</span>,
       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">stool_spec</span>

<span class="va">stool_spec</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/ESBLspecies-1.png" alt="Species cultured from stool." width="576"><p class="caption">
Species cultured from stool.
</p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_stool_spec.pdf"</span><span class="op">)</span>,
         <span class="va">stool_spec</span>,
         width <span class="op">=</span> <span class="fl">6</span>,
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUP_FIG_stool_spec.svg"</span><span class="op">)</span>,
         <span class="va">stool_spec</span>,
         width <span class="op">=</span> <span class="fl">6</span>, 
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="baseline-associations-of-esbl-colonisation" class="section level3">
<h3 class="hasAnchor">
<a href="#baseline-associations-of-esbl-colonisation" class="anchor"></a>Baseline associations of ESBL colonisation</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># helper function for univariable ods ratios</span>

<span class="va">univ_or</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">oc_var</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">varz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
  <span class="va">varz</span> <span class="op">&lt;-</span> <span class="va">varz</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="va">oc_var</span>, <span class="va">varz</span><span class="op">)</span><span class="op">]</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">varz</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">oc_var</span>, <span class="st">" ~ "</span> ,<span class="va">varz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="va">modout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">form</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>
    <span class="va">dfout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">modout</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">dfout</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dfout</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span><span class="op">]</span>, <span class="va">exp</span><span class="op">)</span>
    <span class="va">dfout</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dfout</span>, <span class="va">term</span>, <span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span>, <span class="va">p.value</span><span class="op">)</span>
    <span class="va">dfout</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dfout</span>, <span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span>
    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dfout</span>
  <span class="op">}</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">out</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># get the variables we need</span>

<span class="va">btESBL_participants</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">pid</span>,
    <span class="va">arm</span>,
    <span class="va">calc_age</span>,
    <span class="va">ptsex</span>,
    <span class="va">hivstatus</span>,
    <span class="va">hivonart</span>,
    <span class="va">hivcpt</span>,
    <span class="va">tbongoing</span>,
    <span class="va">recieved_prehosp_ab</span>,
    <span class="va">pmhxrechospital</span>,
    <span class="va">watersource</span>,
    <span class="va">watertreated</span>,
    <span class="va">toilet</span>,
    <span class="va">housholdadultsno</span>,
    <span class="va">householdchildno</span>,
    <span class="va">keepanim</span>,
    <span class="va">enroll_date</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">visit</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">ESBL</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    toilet <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">toilet</span> <span class="op">==</span> <span class="st">"Flush Toliet (any type)"</span> <span class="op">~</span> <span class="st">"Flush toilet"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Latrine or no toilet"</span>
    <span class="op">)</span>,
    watersource <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">watersource</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"Unprotected well/spring"</span>,
        <span class="st">"Surface water (including rainwater collection)"</span>
      <span class="op">)</span> <span class="op">~</span>
        <span class="st">"Unprotected"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Protected"</span>
    <span class="op">)</span>,
    season <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">enroll_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">11</span> <span class="op">|</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">enroll_date</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"rainy"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"dry"</span><span class="op">)</span>,
    arm <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Sepsis"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Inpatient"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Community"</span><span class="op">)</span>,
    ESBL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"hiv|tb"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="st">"No"</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pid"</span>, <span class="st">"enroll_date"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">bl.esbl</span>
<span class="co">#&gt; Joining, by = "pid"</span>
 
<span class="co"># fit models</span>

<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
  <span class="fu">univ_or</span><span class="op">(</span><span class="va">bl.esbl</span>, <span class="st">"ESBL"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>op <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">specify_decimal</span><span class="op">(</span><span class="va">estimate</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">" ("</span>,
                       <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">conf.low</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">"-"</span>,
                       <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">conf.high</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>
           <span class="op">)</span>,
  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">bl.esbl</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span>,
  conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span> <span class="va">term</span>, <span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span>, <span class="va">p.value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"term|p"</span><span class="op">)</span>, <span class="va">exp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>op <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">specify_decimal</span><span class="op">(</span><span class="va">estimate</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">" ("</span>,
                       <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">conf.low</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">"-"</span>,
                       <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">conf.high</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>
    <span class="op">)</span>,
  by <span class="op">=</span> <span class="st">"term"</span>,
  suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_uv"</span>, <span class="st">"_mv"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">log_regESBL</span>

<span class="co"># recode variables lookup vector</span>
    
<span class="va">recode.str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>calc_age <span class="op">=</span> <span class="st">"Age (per year)"</span>,
  ptsexMale <span class="op">=</span> <span class="st">"Male sex (vs female)"</span>,
  armInpatient <span class="op">=</span> <span class="st">"Inpatient (vs community)"</span>,
  armSepsis <span class="op">=</span> <span class="st">"Sepsis (vs community)"</span>,
  
  hivstatusReactive <span class="op">=</span> <span class="st">"HIV+ (vs HIV-)"</span>,
  hivstatusUnknown <span class="op">=</span> <span class="st">"HIV unknown (vs HIV-)"</span>,
  hivcptYes <span class="op">=</span> <span class="st">"CPT (vs none)"</span>,
  pmhxrechospitalYes <span class="op">=</span> <span class="st">"Hospitalisation"</span>,
  recieved_prehosp_abYes <span class="op">=</span> <span class="st">"Antibiotics*"</span>,
  tbongoingYes <span class="op">=</span> <span class="st">"Current TB treatment"</span>,
  housholdadultsno <span class="op">=</span> <span class="st">"Adults (per 1)"</span>,
  householdchildno <span class="op">=</span> <span class="st">"Children (per 1)"</span>,
  keepanimYes <span class="op">=</span> <span class="st">"Keep animals (vs. not)"</span>,
  `toiletLatrine or no toilet` <span class="op">=</span> <span class="st">"Flushing toilet (vs. not)"</span>,
  watersourceUnprotected <span class="op">=</span> <span class="st">"Unprotected water source"</span>,
  watertreatedYes <span class="op">=</span> <span class="st">"Treat water (vs not)"</span>,
  seasonrainy <span class="op">=</span> <span class="st">"Rainy season (vs. dry)"</span>
  
  <span class="op">)</span>



<span class="va">log_regESBL</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"p\\.value"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">0.001</span> <span class="op">~</span> <span class="st">"&lt;0.001"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">.x</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">term</span>,<span class="va">op_uv</span>, <span class="va">p.value_uv</span>,
         <span class="va">op_mv</span>, <span class="va">p.value_mv</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode_factor</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">recode.str</span>, .ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span> col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Variable"</span>,
                        <span class="st">"OR (95\\% CI)"</span>, 
                        <span class="st">"p-value"</span>, 
                        <span class="st">"aOR (95\\% CI)"</span>,
                        <span class="st">"p-value"</span><span class="op">)</span>,
      caption <span class="op">=</span> <span class="st">"Univariable and multivariable associations of ESBL colonisation at enrolment"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_classic</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/column_spec.html">column_spec</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, bold <span class="op">=</span> <span class="va">log_regESBL</span><span class="op">$</span><span class="va">p.value_uv</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/column_spec.html">column_spec</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">5</span>, bold <span class="op">=</span> <span class="va">log_regESBL</span><span class="op">$</span><span class="va">p.value_mv</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">%&gt;%</span> 
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Study Arm"</span>, <span class="fl">1</span>,<span class="fl">2</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Demographics"</span>, <span class="fl">3</span>,<span class="fl">4</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"HIV status"</span>, <span class="fl">5</span>,<span class="fl">8</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Healthcare exposure"</span>, <span class="fl">9</span>,<span class="fl">11</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Household"</span>, <span class="fl">12</span>,<span class="fl">17</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Season"</span>, <span class="fl">18</span>,<span class="fl">18</span>, bold <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/add_header_above.html">add_header_above</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" "</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Univariable"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Multivariable"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/footnote.html">footnote</a></span><span class="op">(</span>general <span class="op">=</span> <span class="st">"CPT = Cotrimoxazole preventative therapy, ART = antiretroviral therapy, TB = tuberculosis. Entries in bold are those for which 95% confidence intervals do not cross 1."</span>, symbol <span class="op">=</span> <span class="st">"Antibiotics includes TB therapy but excludes CPT."</span><span class="op">)</span> </code></pre></div>
<table class="table  lightable-classic">
<caption>
Univariable and multivariable associations of ESBL colonisation at enrolment
</caption>
<thead>
<tr>
<th style="empty-cells: hide;" colspan="1">
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Univariable
</div>
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Multivariable
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
OR (95% CI)
</th>
<th style="text-align:left;">
p-value
</th>
<th style="text-align:left;">
aOR (95% CI)
</th>
<th style="text-align:left;">
p-value
</th>
</tr>
</thead>
<tbody>
<tr grouplength="2">
<td colspan="5" style="border-bottom: 0;">
Study Arm
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Inpatient (vs community)
</td>
<td style="text-align:left;">
1.79 (1.00-3.26)
</td>
<td style="text-align:left;">
0.054
</td>
<td style="text-align:left;">
1.68 (0.81-3.53)
</td>
<td style="text-align:left;">
0.164
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Sepsis (vs community)
</td>
<td style="text-align:left;font-weight: bold;">
2.45 (1.48-4.12)
</td>
<td style="text-align:left;font-weight: bold;">
&lt;0.001
</td>
<td style="text-align:left;">
1.08 (0.54-2.22)
</td>
<td style="text-align:left;">
0.822
</td>
</tr>
<tr grouplength="2">
<td colspan="5" style="border-bottom: 0;">
Demographics
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Age (per year)
</td>
<td style="text-align:left;">
1.00 (0.99-1.02)
</td>
<td style="text-align:left;">
0.709
</td>
<td style="text-align:left;">
1.00 (0.98-1.02)
</td>
<td style="text-align:left;">
0.922
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Male sex (vs female)
</td>
<td style="text-align:left;">
1.23 (0.84-1.82)
</td>
<td style="text-align:left;">
0.287
</td>
<td style="text-align:left;">
1.44 (0.94-2.21)
</td>
<td style="text-align:left;">
0.098
</td>
</tr>
<tr grouplength="4">
<td colspan="5" style="border-bottom: 0;">
HIV status
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
HIV+ (vs HIV-)
</td>
<td style="text-align:left;font-weight: bold;">
1.68 (1.09-2.59)
</td>
<td style="text-align:left;font-weight: bold;">
0.018
</td>
<td style="text-align:left;">
1.21 (0.48-2.99)
</td>
<td style="text-align:left;">
0.679
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
HIV unknown (vs HIV-)
</td>
<td style="text-align:left;">
0.71 (0.40-1.24)
</td>
<td style="text-align:left;">
0.229
</td>
<td style="text-align:left;">
1.08 (0.54-2.16)
</td>
<td style="text-align:left;">
0.820
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
hivonartYes
</td>
<td style="text-align:left;font-weight: bold;">
1.99 (1.32-3.00)
</td>
<td style="text-align:left;font-weight: bold;">
0.001
</td>
<td style="text-align:left;">
1.07 (0.35-3.23)
</td>
<td style="text-align:left;">
0.905
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
CPT (vs none)
</td>
<td style="text-align:left;font-weight: bold;">
2.46 (1.58-3.86)
</td>
<td style="text-align:left;font-weight: bold;">
&lt;0.001
</td>
<td style="text-align:left;">
2.34 (1.00-5.66)
</td>
<td style="text-align:left;">
0.053
</td>
</tr>
<tr grouplength="3">
<td colspan="5" style="border-bottom: 0;">
Healthcare exposure
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Current TB treatment
</td>
<td style="text-align:left;">
1.02 (0.33-2.99)
</td>
<td style="text-align:left;">
0.971
</td>
<td style="text-align:left;">
0.51 (0.13-1.80)
</td>
<td style="text-align:left;">
0.300
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Antibiotics*
</td>
<td style="text-align:left;font-weight: bold;">
1.81 (1.05-3.16)
</td>
<td style="text-align:left;font-weight: bold;">
0.034
</td>
<td style="text-align:left;">
1.24 (0.64-2.41)
</td>
<td style="text-align:left;">
0.528
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hospitalisation
</td>
<td style="text-align:left;font-weight: bold;">
7.87 (2.57-34.22)
</td>
<td style="text-align:left;font-weight: bold;">
0.001
</td>
<td style="text-align:left;font-weight: bold;">
6.64 (1.98-30.75)
</td>
<td style="text-align:left;font-weight: bold;">
0.005
</td>
</tr>
<tr grouplength="6">
<td colspan="5" style="border-bottom: 0;">
Household
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Unprotected water source
</td>
<td style="text-align:left;">
2.43 (0.96-6.64)
</td>
<td style="text-align:left;">
0.068
</td>
<td style="text-align:left;font-weight: bold;">
2.96 (1.07-8.75)
</td>
<td style="text-align:left;font-weight: bold;">
0.040
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Treat water (vs not)
</td>
<td style="text-align:left;">
1.16 (0.50-2.66)
</td>
<td style="text-align:left;">
0.725
</td>
<td style="text-align:left;">
0.95 (0.37-2.37)
</td>
<td style="text-align:left;">
0.913
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Flushing toilet (vs. not)
</td>
<td style="text-align:left;">
0.72 (0.29-1.80)
</td>
<td style="text-align:left;">
0.481
</td>
<td style="text-align:left;">
1.11 (0.41-3.04)
</td>
<td style="text-align:left;">
0.842
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Adults (per 1)
</td>
<td style="text-align:left;">
1.14 (0.99-1.31)
</td>
<td style="text-align:left;">
0.064
</td>
<td style="text-align:left;font-weight: bold;">
1.20 (1.03-1.40)
</td>
<td style="text-align:left;font-weight: bold;">
0.024
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Children (per 1)
</td>
<td style="text-align:left;">
1.00 (0.87-1.14)
</td>
<td style="text-align:left;">
0.979
</td>
<td style="text-align:left;">
0.98 (0.84-1.13)
</td>
<td style="text-align:left;">
0.747
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Keep animals (vs. not)
</td>
<td style="text-align:left;">
1.33 (0.88-2.03)
</td>
<td style="text-align:left;">
0.176
</td>
<td style="text-align:left;">
1.15 (0.72-1.84)
</td>
<td style="text-align:left;">
0.552
</td>
</tr>
<tr grouplength="1">
<td colspan="5" style="border-bottom: 0;">
Season
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Rainy season (vs. dry)
</td>
<td style="text-align:left;font-weight: bold;">
2.05 (1.38-3.06)
</td>
<td style="text-align:left;font-weight: bold;">
&lt;0.001
</td>
<td style="text-align:left;font-weight: bold;">
2.21 (1.40-3.50)
</td>
<td style="text-align:left;font-weight: bold;">
&lt;0.001
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> CPT = Cotrimoxazole preventative therapy, ART = antiretroviral therapy, TB = tuberculosis. Entries in bold are those for which 95% confidence intervals do not cross 1.
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup>*</sup> Antibiotics includes TB therapy but excludes CPT.
</td>
</tr>
</tfoot>
</table>
</div>
<div id="longitudinal-carriage" class="section level3">
<h3 class="hasAnchor">
<a href="#longitudinal-carriage" class="anchor"></a>Longitudinal carriage</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">


<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
  <span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">visit</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
              n_esbl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span><span class="op">)</span>,
  
  <span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">btESBL_stoolorgs</span> <span class="op">%&gt;%</span> 
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lab_id</span>,<span class="va">organism</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">visit</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      n_esco <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">organism</span> <span class="op">==</span> <span class="st">"Escherichia coli"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
      n_kleb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">organism</span> <span class="op">==</span> <span class="st">"Klebsiella pneumoniae"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    esbl_str <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_esbl</span>, <span class="st">" ("</span>,
                      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">n_esbl</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">/</span> <span class="va">n</span>, <span class="fl">0</span><span class="op">)</span>,
                      <span class="st">"%)"</span><span class="op">)</span>,
    esco_str <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_esco</span>, <span class="st">" ("</span>,
                      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">n_esco</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">/</span> <span class="va">n</span>, <span class="fl">0</span><span class="op">)</span>,
                      <span class="st">"%)"</span><span class="op">)</span>,
    kleb_str <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_kleb</span>, <span class="st">" ("</span>,
                      <span class="fu">specify_decimal</span><span class="op">(</span><span class="va">n_kleb</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">/</span> <span class="va">n</span>, <span class="fl">0</span><span class="op">)</span>,
                      <span class="st">"%)"</span><span class="op">)</span>,
    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">visit</span>, <span class="va">arm</span>, <span class="va">n</span>, <span class="va">esbl_str</span>, <span class="va">esco_str</span>, <span class="va">kleb_str</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
    id_cols <span class="op">=</span> <span class="va">visit</span> ,
    names_from <span class="op">=</span> <span class="va">arm</span>,
    values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"esbl_str"</span>, <span class="st">"esco_str"</span>, <span class="st">"kleb_str"</span><span class="op">)</span>,
    values_fill <span class="op">=</span> <span class="st">"-"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">visit</span>,
    <span class="va">n_1</span>,
    <span class="va">esbl_str_1</span>,
    <span class="va">esco_str_1</span>,
    <span class="va">kleb_str_1</span>,
    <span class="va">n_2</span>,
    <span class="va">esbl_str_2</span>,
    <span class="va">esco_str_2</span>,
    <span class="va">kleb_str_2</span>,
    <span class="va">n_3</span>,
    <span class="va">esbl_str_3</span>,
    <span class="va">esco_str_3</span>,
    <span class="va">kleb_str_3</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    visit <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">visit</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Baseline"</span>,
      <span class="va">visit</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Day 7"</span>,
      <span class="va">visit</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Day 28"</span>,
      <span class="va">visit</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Day 90"</span>,
      <span class="va">visit</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Day 180"</span>
    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Visit"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"ESBL"</span>, <span class="st">"E. coli"</span>, <span class="st">"K. pneumo"</span><span class="op">)</span>, <span class="fl">3</span>
      <span class="op">)</span><span class="op">)</span>,
      caption <span class="op">=</span> <span class="st">"ESBL, E. coli and K. pneumoniae prevalence in stool at study visits, stratified by study arm."</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_classic</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/add_header_above.html">add_header_above</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">" "</span> <span class="op">=</span> <span class="fl">1</span>,
        <span class="st">"Sepsis"</span> <span class="op">=</span> <span class="fl">4</span>,
        <span class="st">"Inpatient"</span> <span class="op">=</span> <span class="fl">4</span>,
        <span class="st">"Community"</span> <span class="op">=</span> <span class="fl">4</span>
      <span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm'. You can override using the `.groups` argument.</span>
<span class="co">#&gt; Joining, by = "lab_id"</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm'. You can override using the `.groups` argument.</span>
<span class="co">#&gt; Joining, by = c("arm", "visit")</span></code></pre></div>
<table class="table  lightable-classic">
<caption>
ESBL, E. coli and K. pneumoniae prevalence in stool at study visits, stratified by study arm.
</caption>
<thead>
<tr>
<th style="empty-cells: hide;" colspan="1">
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Sepsis
</div>
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Inpatient
</div>
</th>
<th style="padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">
<div style="border-bottom: 1px solid #111111; margin-bottom: -1px; ">
Community
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
Visit
</th>
<th style="text-align:left;">
n
</th>
<th style="text-align:left;">
ESBL
</th>
<th style="text-align:left;">
E. coli
</th>
<th style="text-align:left;">
K. pneumo
</th>
<th style="text-align:left;">
n
</th>
<th style="text-align:left;">
ESBL
</th>
<th style="text-align:left;">
E. coli
</th>
<th style="text-align:left;">
K. pneumo
</th>
<th style="text-align:left;">
n
</th>
<th style="text-align:left;">
ESBL
</th>
<th style="text-align:left;">
E. coli
</th>
<th style="text-align:left;">
K. pneumo
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Baseline
</td>
<td style="text-align:left;">
222
</td>
<td style="text-align:left;">
109 (49%)
</td>
<td style="text-align:left;">
98 (44%)
</td>
<td style="text-align:left;">
34 (15%)
</td>
<td style="text-align:left;">
99
</td>
<td style="text-align:left;">
41 (41%)
</td>
<td style="text-align:left;">
35 (35%)
</td>
<td style="text-align:left;">
10 (10%)
</td>
<td style="text-align:left;">
99
</td>
<td style="text-align:left;">
28 (28%)
</td>
<td style="text-align:left;">
25 (25%)
</td>
<td style="text-align:left;">
6 (6%)
</td>
</tr>
<tr>
<td style="text-align:left;">
Day 7
</td>
<td style="text-align:left;">
162
</td>
<td style="text-align:left;">
127 (78%)
</td>
<td style="text-align:left;">
122 (75%)
</td>
<td style="text-align:left;">
45 (28%)
</td>
<td style="text-align:left;">
63
</td>
<td style="text-align:left;">
32 (51%)
</td>
<td style="text-align:left;">
27 (43%)
</td>
<td style="text-align:left;">
8 (13%)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;">
Day 28
</td>
<td style="text-align:left;">
148
</td>
<td style="text-align:left;">
106 (72%)
</td>
<td style="text-align:left;">
97 (66%)
</td>
<td style="text-align:left;">
46 (31%)
</td>
<td style="text-align:left;">
71
</td>
<td style="text-align:left;">
37 (52%)
</td>
<td style="text-align:left;">
30 (42%)
</td>
<td style="text-align:left;">
16 (23%)
</td>
<td style="text-align:left;">
92
</td>
<td style="text-align:left;">
29 (32%)
</td>
<td style="text-align:left;">
23 (25%)
</td>
<td style="text-align:left;">
9 (10%)
</td>
</tr>
<tr>
<td style="text-align:left;">
Day 90
</td>
<td style="text-align:left;">
126
</td>
<td style="text-align:left;">
71 (56%)
</td>
<td style="text-align:left;">
62 (49%)
</td>
<td style="text-align:left;">
24 (19%)
</td>
<td style="text-align:left;">
60
</td>
<td style="text-align:left;">
29 (48%)
</td>
<td style="text-align:left;">
25 (42%)
</td>
<td style="text-align:left;">
4 (7%)
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
<td style="text-align:left;">
<ul><li></ul>
</td>
</tr>
<tr>
<td style="text-align:left;">
Day 180
</td>
<td style="text-align:left;">
127
</td>
<td style="text-align:left;">
61 (48%)
</td>
<td style="text-align:left;">
55 (43%)
</td>
<td style="text-align:left;">
24 (19%)
</td>
<td style="text-align:left;">
65
</td>
<td style="text-align:left;">
29 (45%)
</td>
<td style="text-align:left;">
23 (35%)
</td>
<td style="text-align:left;">
5 (8%)
</td>
<td style="text-align:left;">
82
</td>
<td style="text-align:left;">
23 (28%)
</td>
<td style="text-align:left;">
18 (22%)
</td>
<td style="text-align:left;">
2 (2%)
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fills</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#A25050"</span>,<span class="st">"#6497b1"</span>,<span class="st">"#7cb9b9"</span><span class="op">)</span>



<span class="va">cols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#8F2727"</span>,<span class="st">"#03396c"</span>,<span class="st">"#278f8f"</span><span class="op">)</span>

<span class="co"># get first ab exposure </span>
<span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span> 
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_exposures</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span>assess_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">assess_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>any_abx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span>
        <span class="st">"pid|assess|hosp|died"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">any_abx</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">assess_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>first_ab <span class="op">=</span> <span class="va">assess_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">first_ab</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># and hospital exposure</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_exposures</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span>assess_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">assess_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hosp</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">assess_type</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>first_hosp <span class="op">=</span> <span class="va">assess_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">first_hosp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># censor as described</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="op">(</span><span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">first_ab</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">first_ab</span> <span class="op">&lt;</span> <span class="va">t</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">first_ab</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">first_ab</span> <span class="op">&lt;</span> <span class="va">t</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">first_hosp</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">first_hosp</span> <span class="op">&lt;</span> <span class="va">t</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Inpatient:\nantimicrobials"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Inpatient:\nno antimicrobials"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Community"</span><span class="op">)</span>,
    arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">arm</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Inpatient:\nantimicrobials"</span>, 
                                 <span class="st">"Inpatient:\nno antimicrobials"</span>,
                                 <span class="st">"Community"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">t</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span>, 
               color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">arm</span><span class="op">)</span>, 
               group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">arm</span><span class="op">)</span>,
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">arm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">180</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">fills</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
<span class="co">#  scale_color_npg() +</span>
 <span class="co">#   scale_fill_npg() + </span>
<span class="co">#  scale_color_manual(values = pal_lancet()(3)[c(2,1,3)]) + </span>
 <span class="co"># scale_fill_manual(values = pal_lancet()(3)[c(2,1,3)]) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Day post enrollment"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"ESBL-E prevalence"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ESBLprevplot</span>
<span class="co">#&gt; Joining, by = "pid"</span>
<span class="co">#&gt; Joining, by = "pid"</span></code></pre></div>
<p>Describe carriage prevalence; plot model parameters; plot predicted prevalence.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">inv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">log2scale</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">color_scheme_set</span><span class="op">(</span>scheme <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span>

<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">btESBL_model2posterior</span>,
  regex_pars <span class="op">=</span> <span class="st">"alpha|beta"</span>,
  area_method <span class="op">=</span> <span class="st">"equal height"</span>,
  prob <span class="op">=</span> <span class="fl">0.95</span>,
  prob_outer <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alphas[1]"</span>, <span class="st">"betas[1]"</span>, <span class="st">"alphas[2]"</span>, <span class="st">"betas[2]"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alphas[1]"</span> <span class="op">=</span> <span class="st">"Loss[abx]"</span>, <span class="co">#expression(paste(alpha,"[abx]")),</span>
                              <span class="st">"alphas[2]"</span> <span class="op">=</span> <span class="st">"Loss[hosp]"</span>, <span class="co">#expression(paste(alpha,"[hosp]")),</span>
                              <span class="st">"betas[1]"</span> <span class="op">=</span> <span class="st">"Gain[abx]"</span>, <span class="co">#expression(paste(beta,"[abx]")),</span>
                              <span class="st">"betas[2]"</span> <span class="op">=</span> <span class="st">"Gain[hosp]"</span> <span class="co">#expression(paste(beta,"[hosp]"))</span>
                              <span class="op">)</span>,
    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Log HR ESBL gain/loss"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>

<span class="fu">mcmc_areas</span><span class="op">(</span>
    <span class="va">btESBL_model2posterior</span>,
    regex_pars <span class="op">=</span> <span class="st">"alphas.2|betas.2"</span>,area_method <span class="op">=</span> <span class="st">"equal height"</span>,
    point_est <span class="op">=</span> <span class="st">"median"</span>, transformations <span class="op">=</span> <span class="va">exp</span>, prob <span class="op">=</span> <span class="fl">0.95</span>, 
    prob_outer <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"t(betas[2])"</span>, <span class="st">"t(alphas[2])"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
                              <span class="st">"t(alphas[2])"</span> <span class="op">=</span> <span class="st">"Loss[hosp]"</span>, 
                              <span class="st">"t(betas[2])"</span> <span class="op">=</span> <span class="st">"Gain[hosp]"</span>
                              <span class="op">)</span>,
    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a.1</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>

<span class="fu">mcmc_areas</span><span class="op">(</span>
    <span class="va">btESBL_model2posterior</span>,
    regex_pars <span class="op">=</span> <span class="st">"alphas.1|betas.1"</span>,area_method <span class="op">=</span> <span class="st">"equal height"</span>,
    point_est <span class="op">=</span> <span class="st">"median"</span>, transformations <span class="op">=</span> <span class="va">exp</span>, prob <span class="op">=</span> <span class="fl">0.95</span>, 
    prob_outer <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"t(betas[1])"</span>, <span class="st">"t(alphas[1])"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
                              <span class="st">"t(alphas[1])"</span> <span class="op">=</span> <span class="st">"Loss[abx]"</span>, 
                              <span class="st">"t(betas[1])"</span> <span class="op">=</span> <span class="st">"Gain[abx]"</span>
                              <span class="op">)</span>,
    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Hazard ratio  \nESBL gain/loss"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a.2</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>



<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">btESBL_model2posterior</span>,
  regex_pars <span class="op">=</span> <span class="st">"lambda|mu"</span>,
  transformations <span class="op">=</span> <span class="va">inv</span>,
  area_method <span class="op">=</span> <span class="st">"equal height"</span>,
  prob <span class="op">=</span> <span class="fl">0.95</span>,
  prob_outer <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>   <span class="co">#-&gt; c #+ </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(lambda)"</span>, <span class="st">"t(mu)"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(lambda)"</span> <span class="op">=</span> <span class="st">"Uncolonised"</span>, <span class="co">#expression(paste(lambda^'-1')),</span>
                              <span class="st">"t(mu)"</span> <span class="op">=</span> <span class="st">"Colonised"</span><span class="op">)</span>, <span class="co"># expression(paste(mu^'-1'))),</span>
  expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Mean time in state (days)"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>

<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">btESBL_model2posterior</span>,
  regex_pars <span class="op">=</span> <span class="st">"gamma"</span> ,
  transformations <span class="op">=</span> <span class="va">log2scale</span>,
  prob <span class="op">=</span> <span class="fl">0.95</span>,
  prob_outer <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>   <span class="co">#-&gt; c #+ </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="st">"t(gammas[1])"</span>,
                  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(gammas[1])"</span> <span class="op">=</span> <span class="st">"Half life"</span><span class="op">)</span>, <span class="co"># expression(paste(gamma, "log(2))"))),</span>
          <span class="co">#        labels = c("t(gammas[1])" = "\u03b3 log(2)"),</span>
  expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Antimicrobial effect  \nhalf life (days)"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">c</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>

<span class="co"># simulated data</span>



<span class="co">#cols2 = c("#ffcc80", "#a25079","#660066")</span>

<span class="va">btESBL_model2simulations</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>abx_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">abx_days</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">abx_days</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
        median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">pr_esbl_pos</span><span class="op">)</span>,
        lq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pr_esbl_pos</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
        uq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">pr_esbl_pos</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>abx_stop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">abx_days</span><span class="op">)</span>, 
                             <span class="st">" days \nantimicrobials"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
        <span class="va">time</span>,
        <span class="va">median</span>,
        ymin <span class="op">=</span> <span class="va">lq</span>,
        ymax <span class="op">=</span> <span class="va">uq</span>,
        linetype <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">abx_stop</span><span class="op">)</span>,
        fill <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">abx_stop</span><span class="op">)</span>,
        color <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">abx_stop</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">cols</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">cols</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fills</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">fills</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">fills</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"solid"</span>, <span class="st">"dashed"</span>, <span class="st">"solid"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span><span class="co">#linetype = "Antimicrobial exposure",</span>
       <span class="co">#color = "Antimicrobial exposure",</span>
       <span class="co">#fill = "Antimicrobial exposure",</span>
       y <span class="op">=</span> <span class="st">"Simulated ESBL prevalence"</span>,
       x <span class="op">=</span> <span class="st">"Days post enrollment"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">e</span>
<span class="co">#&gt; `summarise()` has grouped output by 'time'. You can override using the `.groups` argument.</span>

<span class="va">a</span> <span class="op">&lt;-</span> <span class="va">a.1</span> <span class="op">/</span> <span class="va">a.2</span>

<span class="op">(</span><span class="op">(</span><span class="va">ESBLprevplot</span> <span class="op">+</span> <span class="va">e</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">a</span> <span class="op">|</span> <span class="va">b</span> <span class="op">|</span> <span class="va">c</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">markov_panel_plot</span>

<span class="va">markov_panel_plot</span>
<span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula 'y ~ x'</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/markov-model-panel-plot-1.png" alt="Determinants of ESBL-E carriage. A: Prevalence of ESBL-E carriage stratified by study arm. Inpatients without sepsis are censored at first antimicrobial exposure and community members censored at first antimicrobial exposure or hospital admission. Estimated prevalence and 95% confience intervals derived from a nonparametric LOESS regression with span parameter 0.8. B: Simulated probability of ESBL colonisation generated from the posterior parameter estimates of the fitted model with a starting probability of colonisation of 0.5 and seven days of hospitalisation with either seven, two, or no days antimicrobial exposure. In this model, truncated courses of antimicrobials havelittle effect on reducing ESBL-E carriage. C-E: Density plots of parameter estimates form fitted model with median (line) and 95% credible intervals (shading) shown. A: log hazard ratios of ESBL-E gain and loss for hospialisation and antimicrobial exposure: hospitalisation acts to acts to increase both acquisition and loss of ESBL-E whereas antmicrobial exposure acts to prevent loss. D: mean time in state for uncolonised and colonised states. E: Half life of decay of effecr of antimicrobials, showing that the effect of antimicrobials, in this model, acts for many days after exposure has finished." width="1152"><p class="caption">
Determinants of ESBL-E carriage. A: Prevalence of ESBL-E carriage stratified by study arm. Inpatients without sepsis are censored at first antimicrobial exposure and community members censored at first antimicrobial exposure or hospital admission. Estimated prevalence and 95% confience intervals derived from a nonparametric LOESS regression with span parameter 0.8. B: Simulated probability of ESBL colonisation generated from the posterior parameter estimates of the fitted model with a starting probability of colonisation of 0.5 and seven days of hospitalisation with either seven, two, or no days antimicrobial exposure. In this model, truncated courses of antimicrobials havelittle effect on reducing ESBL-E carriage. C-E: Density plots of parameter estimates form fitted model with median (line) and 95% credible intervals (shading) shown. A: log hazard ratios of ESBL-E gain and loss for hospialisation and antimicrobial exposure: hospitalisation acts to acts to increase both acquisition and loss of ESBL-E whereas antmicrobial exposure acts to prevent loss. D: mean time in state for uncolonised and colonised states. E: Half life of decay of effecr of antimicrobials, showing that the effect of antimicrobials, in this model, acts for many days after exposure has finished.
</p>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F1_markov_panel.svg"</span><span class="op">)</span>,
         <span class="va">markov_panel_plot</span>,
         width <span class="op">=</span> <span class="fl">10</span>,
         height <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F1_markov_panel.pdf"</span><span class="op">)</span>,
         <span class="va">markov_panel_plot</span>,
         width <span class="op">=</span> <span class="fl">10</span>, 
         height <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="compare-different-paramaterisation-of-antimicrobial-effect" class="section level3">
<h3 class="hasAnchor">
<a href="#compare-different-paramaterisation-of-antimicrobial-effect" class="anchor"></a>Compare different paramaterisation of antimicrobial effect</h3>
<p>Stepwise constant vs exponential decay.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># to</span>

<span class="co"># parameter estimates from model 1 and 2</span>

<span class="fu">mcmc_areas</span><span class="op">(</span><span class="va">btESBL_model1posterior</span>, regex_pars <span class="op">=</span> <span class="st">"alpha|beta"</span>,  area_method <span class="op">=</span> <span class="st">"equal height"</span>, prob <span class="op">=</span> <span class="fl">0.95</span>, prob_outer <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ab_alpha0"</span>, <span class="st">"ab_beta0"</span>, <span class="st">"hosp_alpha1"</span>, <span class="st">"hosp_beta1"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ab_alpha0"</span> <span class="op">=</span> <span class="st">"Loss[abx]"</span>, <span class="co">#expression(paste(alpha,"[abx]")),</span>
                              <span class="st">"hosp_alpha1"</span> <span class="op">=</span> <span class="st">"Loss[hosp]"</span>, <span class="co">#expression(paste(alpha,"[hosp]")),</span>
                              <span class="st">"ab_beta0"</span> <span class="op">=</span> <span class="st">"Gain[abx]"</span>, <span class="co">#expression(paste(beta,"[abx]")),</span>
                              <span class="st">"hosp_beta1"</span> <span class="op">=</span> <span class="st">"Gain[hosp]"</span> <span class="co">#expression(paste(beta,"[hosp]"))</span>
                              <span class="op">)</span>,
    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Log hazard ratio of ESBL gain/loss"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a1</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>

<span class="fu">mcmc_areas</span><span class="op">(</span><span class="va">btESBL_model1posterior</span>, 
           regex_pars <span class="op">=</span> <span class="st">"lambda|mu"</span>,
           transformations <span class="op">=</span> <span class="va">inv</span>, 
           area_method <span class="op">=</span> <span class="st">"equal height"</span>, prob <span class="op">=</span> <span class="fl">0.95</span>, 
           prob_outer <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>   <span class="co">#-&gt; c #+ </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(lambda)"</span>, <span class="st">"t(mu)"</span><span class="op">)</span>,
                   labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(lambda)"</span> <span class="op">=</span> <span class="st">"Uncolonised"</span>, <span class="co">#expression(paste(lambda^'-1')),</span>
                              <span class="st">"t(mu)"</span> <span class="op">=</span> <span class="st">"Colonised"</span><span class="op">)</span>, <span class="co"># expression(paste(mu^'-1'))),</span>
  expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Mean time in state (days)"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b1</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>



<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span>
    <span class="fu">extract_log_lik</span><span class="op">(</span><span class="va">btESBL_model1posterior</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_modeldata</span>, <span class="va">pid</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_participants</span>, <span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"pid"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">arm</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      pred_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      pred_state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pred_prob</span><span class="op">)</span>,
        <span class="fl">1</span>,
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ESBL_stop</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">pred_prob</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">pred_prob</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_state</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pred_state</span><span class="op">)</span>,
               model <span class="op">=</span> <span class="st">"Model 1"</span><span class="op">)</span> ,
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span>
    <span class="fu">extract_log_lik</span><span class="op">(</span><span class="va">btESBL_model2posterior</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_modeldata</span>, <span class="va">pid</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_participants</span>, <span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"pid"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">arm</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      pred_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      pred_state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pred_prob</span><span class="op">)</span>,
        <span class="fl">1</span>,
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ESBL_stop</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">pred_prob</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">pred_prob</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span>, <span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_state</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pred_state</span><span class="op">)</span>,
              model <span class="op">=</span> <span class="st">"Model 2"</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Sepsis"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Inpatient"</span>,
    <span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Community"</span><span class="op">)</span>,
    arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">arm</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepsis"</span>, <span class="st">"Inpatient"</span>, <span class="st">"Community"</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">)</span><span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">prop</span>, group <span class="op">=</span> <span class="va">arm</span>, fill <span class="op">=</span> <span class="va">arm</span>, color <span class="op">=</span> <span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">model</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span>
      <span class="fu">extract_log_lik</span><span class="op">(</span><span class="va">btESBL_model1posterior</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_modeldata</span>, <span class="va">pid</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_participants</span>, <span class="va">pid</span>, <span class="va">arm</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"pid"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">arm</span>, <span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">arm</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ESBL_stop</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ESBL_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
        arm <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
          <span class="va">arm</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Sepsis"</span>,
          <span class="va">arm</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Inpatient"</span>,
          <span class="va">arm</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Community"</span>
        <span class="op">)</span>
      <span class="op">)</span> ,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">prop</span>, color <span class="op">=</span> <span class="va">arm</span><span class="op">)</span>,
    linetype <span class="op">=</span> <span class="st">"dashed"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">fills</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"ESBL-E prevalence"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">post_check</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm'. You can override using the `.groups` argument.</span>
<span class="co">#&gt; `summarise()` has grouped output by 'arm'. You can override using the `.groups` argument.</span>
  
<span class="op">(</span><span class="op">(</span><span class="va">a1</span> <span class="op">+</span> <span class="va">b1</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_spacer.html">plot_spacer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op">/</span> <span class="op">(</span><span class="va">post_check</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_comp_plot</span>

<span class="va">model_comp_plot</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/compare-models-plot-1.png" alt="Model comparisons for models with and without an exponentially dcaying effect of antmicrobials. A-B: Parameter estimates from stepwise-constant covariate model. C-E: parameter estimates from model with exponentially-decaying effect of antinicrobial exposure. F: Posterior predictive checks of modelsm comparing model with piecewise-constant covariates (model 1) to exponentially decaying effect of antimicrobial exposure (model 2). Dashed lines show actual ESBL-E prevalence across three study arms; probability density of predicted prevalence from the two models show that model 1 tends to underestimate ESBL-E prevalence in the antimicrobial-exposed, compared to model 2." width="1056"><p class="caption">
Model comparisons for models with and without an exponentially dcaying effect of antmicrobials. A-B: Parameter estimates from stepwise-constant covariate model. C-E: parameter estimates from model with exponentially-decaying effect of antinicrobial exposure. F: Posterior predictive checks of modelsm comparing model with piecewise-constant covariates (model 1) to exponentially decaying effect of antimicrobial exposure (model 2). Dashed lines show actual ESBL-E prevalence across three study arms; probability density of predicted prevalence from the two models show that model 1 tends to underestimate ESBL-E prevalence in the antimicrobial-exposed, compared to model 2.
</p>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_model_comp_plot.pdf"</span><span class="op">)</span>,
         <span class="va">model_comp_plot</span>,
         width <span class="op">=</span> <span class="fl">11</span>,
         height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_model_comp_plot.svg"</span><span class="op">)</span>,
         <span class="va">model_comp_plot</span>,
         width <span class="op">=</span> <span class="fl">11</span>, 
         height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="table-of-model-parameter-values" class="section level3">
<h3 class="hasAnchor">
<a href="#table-of-model-parameter-values" class="anchor"></a>Table of model parameter values</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu">mcmc_intervals_data</span><span class="op">(</span>
  <span class="va">btESBL_model2posterior</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"alphas[1]"</span>,
    <span class="st">"betas[1]"</span>,
    <span class="st">"alphas[2]"</span>,
    <span class="st">"betas[2]"</span>,
    <span class="st">"gammas[1]"</span>,
    <span class="st">"lambda"</span>,
    <span class="st">"mu"</span>
  <span class="op">)</span>,
  transformations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"alphas[1]"</span> <span class="op">=</span> <span class="va">exp</span>,
    <span class="st">"betas[1]"</span> <span class="op">=</span> <span class="va">exp</span>,
    <span class="st">"alphas[2]"</span> <span class="op">=</span> <span class="va">exp</span>,
    <span class="st">"betas[2]"</span> <span class="op">=</span> <span class="va">exp</span>,
    <span class="st">"gammas[1]"</span> <span class="op">=</span> <span class="va">log2scale</span>,
    <span class="st">"lambda"</span> <span class="op">=</span> <span class="va">inv</span>,
    <span class="st">"mu"</span> <span class="op">=</span> <span class="va">inv</span>
  <span class="op">)</span>,
  prob_outer <span class="op">=</span> <span class="fl">0.95</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">ll</span>,<span class="va">m</span>,<span class="va">hh</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stri <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">'{specify_decimal(m,2)} ({specify_decimal(ll,2)}-{specify_decimal(hh,2)})'</span><span class="op">)</span>,
         parameter2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
           <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="va">parameter</span><span class="op">)</span>  <span class="op">~</span><span class="st">"Hazard ratio ESBL-E Loss"</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="va">parameter</span><span class="op">)</span>  <span class="op">~</span><span class="st">"Hazard ratio ESBL-E Gain"</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="va">parameter</span><span class="op">)</span>  <span class="op">~</span><span class="st">"Half life of effect (days)"</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="va">parameter</span><span class="op">)</span>  <span class="op">~</span><span class="st">"Colonised (days)"</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="va">parameter</span><span class="op">)</span>  <span class="op">~</span><span class="st">"Uncolonised (days)"</span>,
  <span class="op">)</span>,
  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">parameter</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t(alphas[1])"</span>,
                                           <span class="st">"t(betas[1])"</span>,
                                           <span class="st">"t(gammas[1])"</span>,
                                           <span class="st">"t(alphas[2])"</span>,
                                           <span class="st">"t(betas[2])"</span>,
                                           <span class="st">"t(lambda)"</span>,
                                           <span class="st">"t(mu)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">parameter2</span>, <span class="va">stri</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span> 
  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Variable"</span>, <span class="st">"Value"</span><span class="op">)</span>,
  caption <span class="op">=</span> <span class="st">"Parameter estimates (and 95% confidence intervals) from model 2"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_classic</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Effect of Antibacterials"</span>, <span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Effect of Hospitalisation"</span>, <span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/group_rows.html">pack_rows</a></span><span class="op">(</span><span class="st">"Mean time in state"</span>, <span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/footnote.html">footnote</a></span><span class="op">(</span>general <span class="op">=</span> <span class="st">"Hazard ratios are the exponential of the parameters alpha and beta in the model; half life is equal to log(2) multiplied by gamma; mean time in state assumes all other covariates are equal to zero and is then the reciprocal of lambda or mu."</span><span class="op">)</span></code></pre></div>
<table class="table  lightable-classic">
<caption>
Parameter estimates (and 95% confidence intervals) from model 2
</caption>
<thead><tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Value
</th>
</tr></thead>
<tbody>
<tr grouplength="3">
<td colspan="2" style="border-bottom: 0;">
<strong>Effect of Antibacterials</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hazard ratio ESBL-E Loss
</td>
<td style="text-align:left;">
0.16 (0.05-0.58)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hazard ratio ESBL-E Gain
</td>
<td style="text-align:left;">
0.57 (0.16-2.25)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Half life of effect (days)
</td>
<td style="text-align:left;">
43.67 (15.42-97.66)
</td>
</tr>
<tr grouplength="2">
<td colspan="2" style="border-bottom: 0;">
<strong>Effect of Hospitalisation</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hazard ratio ESBL-E Loss
</td>
<td style="text-align:left;">
10.01 (1.24-52.34)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Hazard ratio ESBL-E Gain
</td>
<td style="text-align:left;">
27.82 (3.60-143.18)
</td>
</tr>
<tr grouplength="2">
<td colspan="2" style="border-bottom: 0;">
<strong>Mean time in state</strong>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Colonised (days)
</td>
<td style="text-align:left;">
9.65 (4.22-25.07)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;" indentlevel="1">
Uncolonised (days)
</td>
<td style="text-align:left;">
5.76 (2.54-14.30)
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> Hazard ratios are the exponential of the parameters alpha and beta in the model; half life is equal to log(2) multiplied by gamma; mean time in state assumes all other covariates are equal to zero and is then the reciprocal of lambda or mu.
</td>
</tr>
</tfoot>
</table>
</div>
<div id="compare-out-of-sample-prediction-with-loo" class="section level3">
<h3 class="hasAnchor">
<a href="#compare-out-of-sample-prediction-with-loo" class="anchor"></a>Compare out-of-sample prediction with <em>loo</em>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># compare model 1 and model 2 with loo</span>

<span class="va">ll_m1</span> <span class="op">&lt;-</span> <span class="fu">extract_log_lik</span><span class="op">(</span><span class="va">btESBL_model1posterior</span>, merge_chains <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">r_eff_m1</span> <span class="op">&lt;-</span> <span class="fu">relative_eff</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">ll_m1</span><span class="op">)</span><span class="op">)</span> 

<span class="va">ll_m2</span> <span class="op">&lt;-</span> <span class="fu">extract_log_lik</span><span class="op">(</span><span class="va">btESBL_model2posterior</span>, merge_chains <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">r_eff_m2</span> <span class="op">&lt;-</span> <span class="fu">relative_eff</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">ll_m2</span><span class="op">)</span><span class="op">)</span> 
<span class="va">loo_mod1</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">ll_m1</span>, r_eff <span class="op">=</span> <span class="va">r_eff_m1</span><span class="op">)</span>
<span class="va">loo_mod2</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">ll_m2</span>, r_eff <span class="op">=</span> <span class="va">r_eff_m2</span><span class="op">)</span>
<span class="fu">loo_compare</span><span class="op">(</span><span class="va">loo_mod1</span>, <span class="va">loo_mod2</span><span class="op">)</span>
<span class="co">#&gt;        elpd_diff se_diff</span>
<span class="co">#&gt; model2   0.0       0.0  </span>
<span class="co">#&gt; model1 -10.5       4.2</span></code></pre></div>
</div>
<div id="contig-cluster-associations-with-lineage-and-genus" class="section level3">
<h3 class="hasAnchor">
<a href="#contig-cluster-associations-with-lineage-and-genus" class="anchor"></a>Contig cluster associations with lineage and genus</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># contig clusters: species distn -------------------------------------</span>

<span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">clstr_size</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>clstr_name <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">clstr_name</span><span class="op">)</span><span class="op">)</span>,
         species <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"K. pneumoniae"</span>,
                           <span class="st">"K. pneumoniae\ncomplex"</span>, <span class="va">species</span><span class="op">)</span>,
         species <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"E. coli"</span>, <span class="va">n</span>,<span class="op">-</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">clstr_name</span>, y <span class="op">=</span> <span class="va">n</span>, fill <span class="op">=</span> <span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">40</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">contigs_species_distnplot</span>

<span class="co"># # map to tree</span>

<span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">clstr_size</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">clstr_size</span> <span class="op">&gt;</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">clstr_size</span> <span class="op">&lt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>clstr_name <span class="op">=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">clstr_name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
    id_col <span class="op">=</span> <span class="va">lane</span>,
    names_from <span class="op">=</span> <span class="va">clstr_name</span>,
    values_from <span class="op">=</span> <span class="va">clstr_name</span>,
    values_fn <span class="op">=</span> <span class="va">length</span>,
    values_fill <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">clst.onehot</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">clst.onehot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">clst.onehot</span><span class="op">$</span><span class="va">lane</span>


<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_esco</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span><span class="op">(</span><span class="va">clst.onehot</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">clst.onehot</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
           font.size <span class="op">=</span> <span class="fl">2.5</span>,
           color <span class="op">=</span> <span class="cn">NA</span>,
           width <span class="op">=</span> <span class="fl">3</span>,
           colnames <span class="op">=</span> <span class="cn">TRUE</span>,
           colnames_angle <span class="op">=</span> <span class="fl">90</span>,
           colnames_offset_y <span class="op">=</span> <span class="fl">10</span>,
           colnames_position <span class="op">=</span> <span class="st">"top"</span>,
           hjust <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">570</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"lightgrey"</span>, <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">contigclusters_map_to_tree_esco</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="fu">treeio</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/treeio/reference/tree_subset.html">tree_subset</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_kleb</span>, <span class="fl">210</span>, 
                           levels_back <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span><span class="op">(</span><span class="va">clst.onehot</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">clst.onehot</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
           font.size <span class="op">=</span> <span class="fl">2.5</span>,
           colnames <span class="op">=</span> <span class="cn">FALSE</span>,
           color <span class="op">=</span> <span class="cn">NA</span>,
           width <span class="op">=</span> <span class="fl">3</span>,
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"lightgrey"</span>, <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">contigclusters_map_to_tree_kleb</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>

<span class="op">(</span>
    <span class="op">(</span>
      <span class="op">(</span><span class="va">contigs_species_distnplot</span> <span class="op">|</span> 
         <span class="op">(</span><span class="va">contigclusters_map_to_tree_esco</span> <span class="op">/</span> <span class="va">contigclusters_map_to_tree_kleb</span> <span class="op">+</span> 
            <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.8</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
        <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
     <span class="op">)</span> 
<span class="op">)</span>  <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">species_lineage_mge_association</span>

<span class="va">species_lineage_mge_association</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/plasm-amr-gene-plot-1.png" alt="Distribution of contig-clusters between and within genera. (A) shows distribution of contig clusters by genus. (B-C) show contig-cluster presence (purple)-absence (grey) mapped back to core gene maximum likelihood phylogeny for E. coli (B) and K. pneumoniae subsp. pneumoniae (C)" width="960"><p class="caption">
Distribution of contig-clusters between and within genera. (A) shows distribution of contig clusters by genus. (B-C) show contig-cluster presence (purple)-absence (grey) mapped back to core gene maximum likelihood phylogeny for E. coli (B) and K. pneumoniae subsp. pneumoniae (C)
</p>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F2_spec_lin_mgs_assoc.svg"</span><span class="op">)</span>,
         <span class="va">species_lineage_mge_association</span>,
         width <span class="op">=</span> <span class="fl">10</span>,
         height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F2_spec_lin_mgs_assoc.pdf"</span><span class="op">)</span>,
         <span class="va">species_lineage_mge_association</span>,
         width <span class="op">=</span> <span class="fl">10</span>, 
         height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="contig-cluster-basic-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#contig-cluster-basic-statistics" class="anchor"></a>Contig cluster basic statistics</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">clstr_size</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">clstr_name</span>, <span class="va">clstr_rep</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>clstr_iden <span class="op">=</span> <span class="va">clstr_iden</span> <span class="op">/</span> <span class="fl">100</span>,
           clstr_cov <span class="op">=</span> <span class="va">clstr_cov</span><span class="op">/</span><span class="fl">100</span>, clstr_size2 <span class="op">=</span> <span class="va">clstr_size</span>,
           clstr_rep_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op">(</span><span class="va">length</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,
           length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">length</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
               <span class="co"># select(-length) %&gt;% </span>
               <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id</span>,
                               <span class="va">lane</span>,
                               <span class="va">clstr_rep</span>, 
                               <span class="va">clstr_name</span>,
                               <span class="va">species</span>, 
                               <span class="va">gene</span>, 
                               <span class="va">clstr_size</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode_factor</a></span><span class="op">(</span><span class="va">name</span>,
    <span class="st">"clstr_size2"</span> <span class="op">=</span> <span class="st">"Number of samples in cluster"</span>,
    <span class="st">"clstr_rep_size"</span> <span class="op">=</span> <span class="st">"Log (base 10) length (kBases) of cluster representative sequence"</span>,
      <span class="st">"clstr_iden"</span> <span class="op">=</span> <span class="st">"Distribution of sample sequence identity to cluster representative sequence"</span>,
      <span class="st">"clstr_cov"</span> <span class="op">=</span> <span class="st">"Distribution of sample sequence coverage of cluster representative sequence"</span>,
      <span class="st">"length"</span> <span class="op">=</span> <span class="st">"Distributrion of log (base 10) sample sequence length (kBases)"</span><span class="op">)</span>,
    .ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">clstr_name</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">clstr_size</span><span class="op">)</span><span class="op">)</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">name</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>
    angle <span class="op">=</span> <span class="fl">90</span>,
    hjust <span class="op">=</span> <span class="fl">1</span>,
    size <span class="op">=</span> <span class="fl">6</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Cluster identifier"</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">esbl_contig_stats</span>

<span class="va">esbl_contig_stats</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/contig-cluster-stats-1.png" alt="Size, representative cluster length, distribution of coverage and sequence identity of ESBL-contig clusters" width="864"><p class="caption">
Size, representative cluster length, distribution of coverage and sequence identity of ESBL-contig clusters
</p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_esbl_contig_stat.svg"</span><span class="op">)</span>,
         <span class="va">esbl_contig_stats</span>,
         width <span class="op">=</span> <span class="fl">9</span>,
         height <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_esbl_contig_stat.pdf"</span><span class="op">)</span>,
         <span class="va">esbl_contig_stats</span>,
         width <span class="op">=</span> <span class="fl">9</span>, 
         height <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="poppunk-clusters-mapped-to-phylogeny" class="section level3">
<h3 class="hasAnchor">
<a href="#poppunk-clusters-mapped-to-phylogeny" class="anchor"></a>popPUNK clusters mapped to phylogeny</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Taxon <span class="op">=</span> <span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>clst_size <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
         Cluster <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">Cluster</span>, <span class="va">clst_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="co">#  select(Taxon, Cluster) %&gt;% </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">clst_size</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">clst_size</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">Taxon</span>,
              names_from <span class="op">=</span> <span class="va">Cluster</span>,
              values_from <span class="op">=</span> <span class="va">Cluster</span>,
              values_fn <span class="op">=</span> <span class="va">length</span>,
              values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pp.onehot.k</span>

<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Taxon <span class="op">=</span> <span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>clst_size <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
         Cluster <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">Cluster</span>, <span class="va">clst_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="co">#  select(Taxon, Cluster) %&gt;% </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">clst_size</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">clst_size</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">Taxon</span>,
              names_from <span class="op">=</span> <span class="va">Cluster</span>,
              values_from <span class="op">=</span> <span class="va">Cluster</span>,
              values_fn <span class="op">=</span> <span class="va">length</span> ,
              values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pp.onehot.e</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">pp.onehot.e</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pp.onehot.e</span><span class="op">$</span><span class="va">Taxon</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">pp.onehot.k</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pp.onehot.k</span><span class="op">$</span><span class="va">Taxon</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_esco</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span><span class="op">(</span><span class="va">pp.onehot.e</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
           font.size <span class="op">=</span> <span class="fl">2</span>,
           color <span class="op">=</span> <span class="cn">NA</span>,
           width <span class="op">=</span> <span class="fl">3</span>,
           colnames <span class="op">=</span> <span class="cn">TRUE</span>,
           colnames_angle <span class="op">=</span> <span class="fl">90</span>,
           colnames_offset_y <span class="op">=</span> <span class="fl">10</span>,
           colnames_position <span class="op">=</span> <span class="st">"top"</span>,
           hjust <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"lightgrey"</span>, <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span>  <span class="op">-&gt;</span>
  <span class="va">pp.maptotree.e</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="fu">treeio</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/treeio/reference/tree_subset.html">tree_subset</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_kleb</span>, <span class="fl">210</span>, 
                           levels_back <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span><span class="op">(</span><span class="va">pp.onehot.k</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
           font.size <span class="op">=</span> <span class="fl">2</span>,
           color <span class="op">=</span> <span class="cn">NA</span>,
           width <span class="op">=</span> <span class="fl">3</span>,
           colnames <span class="op">=</span> <span class="cn">TRUE</span>,
           colnames_angle <span class="op">=</span> <span class="fl">90</span>,
           colnames_offset_y <span class="op">=</span> <span class="fl">10</span>,
           colnames_position <span class="op">=</span> <span class="st">"top"</span>,
           hjust <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"lightgrey"</span>, <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span>  <span class="op">-&gt;</span>
  <span class="va">pp.maptotree.k</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>

<span class="op">(</span><span class="va">pp.maptotree.e</span> <span class="op">/</span> <span class="va">pp.maptotree.k</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">pp.maptotree</span>


<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_popunk_maptotree.pdf"</span><span class="op">)</span>,
         <span class="va">pp.maptotree</span>,
         width <span class="op">=</span> <span class="fl">12</span>,
         height <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_popunk_maptotree.svg"</span><span class="op">)</span>,
         <span class="va">pp.maptotree</span>,
         width <span class="op">=</span> <span class="fl">12</span>, 
         height <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">pp.maptotree</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/popPUNK+map_to_phylogeny-1.png" alt="PopPUNK clusters mapped to core gene maximum-likelihood phylogeny" width="1152"><p class="caption">
PopPUNK clusters mapped to core gene maximum-likelihood phylogeny
</p>
</div>
</div>
<div id="within-participant-temporal-correlation" class="section level3">
<h3 class="hasAnchor">
<a href="#within-participant-temporal-correlation" class="anchor"></a>Within-participant temporal correlation</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># prepare list column tibble</span>

<span class="va">btESBL_snpdists_esco</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"sample"</span>,
         <span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"name"</span>,
         <span class="st">"snpdist_esco"</span> <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.x"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.y"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lab_id.x</span>, <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>same_snpclust_esco <span class="op">=</span> <span class="va">snpdist_esco</span> <span class="op">&lt;=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">snpdist.e.long</span>

<span class="va">btESBL_snpdists_kleb</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"sample"</span>,
         <span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"name"</span>,
         <span class="st">"snpdist_kleb"</span> <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.x"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.y"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lab_id.x</span>, <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>same_snpclust_kleb <span class="op">=</span> <span class="va">snpdist_kleb</span> <span class="op">&lt;=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">snpdist.k.long</span>

<span class="co"># make list-column df -----------------------------------------------------</span>


<span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_stoolorgs</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lab_id</span>, <span class="va">organism</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="st">"lab_id"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>orgs <span class="op">=</span> <span class="va">organism</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">supplier_name</span>, <span class="va">Cluster</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>pp_clust <span class="op">=</span> <span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span>  
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span> , <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">supplier_name</span>, <span class="va">clstr_name</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>contig_clust <span class="op">=</span> <span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>lanes <span class="op">=</span> <span class="va">lane</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>
<span class="co">#&gt; Joining, by = "lane"</span>

<span class="va">samples</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>delta_t <span class="op">=</span> 
           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">delta_t</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>
<span class="co"># compare presence absence of clusters</span>

<span class="va">samples</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>esbl.x.and.y <span class="op">=</span> <span class="va">ESBL.x</span> <span class="op">==</span> <span class="st">"Positive"</span> <span class="op">&amp;</span>
           <span class="va">ESBL.y</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">#compare ESCO poppunk clusters between x and y</span>
  <span class="co"># and add variables for e coli cluster and presence/absence</span>
  <span class="co"># e coli to later remove isolates that weren't sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    same.esco.poppunk.xandy <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">pp_clust.x</span>,
           <span class="va">pp_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flags for existence of poppunk clusters</span>
    esco.poppunk.cluster.exists.x <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    esco.poppunk.cluster.exists.y <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.y</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flag for existence of esco</span>
    esco.exists.x <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"coli"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    esco.exists.y <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.y</span>,  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"coli"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    same.esco.xandy <span class="op">=</span> <span class="va">esco.exists.x</span> <span class="op">&amp;</span> <span class="va">esco.exists.y</span>,
    <span class="co"># contig clusters</span>
    same.contig.cluster <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">contig_clust.x</span>,
           <span class="va">contig_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">clstr_name</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># same but for klebs</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    same.kleb.poppunk.xandy <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">pp_clust.x</span>,
           <span class="va">pp_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flags for existence of poppunk clusters</span>
    kleb.poppunk.cluster.exists.x <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    kleb.poppunk.cluster.exists.y <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.y</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flag for existence of kleb</span>
    kleb.exists.x <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Klebsiella pneumoniae"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    kleb.exists.y <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.y</span>,  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Klebsiella pneumoniae"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    same.kleb.xandy <span class="op">=</span> <span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="va">kleb.exists.y</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">samples</span>

<span class="co"># merge in snpdist clusters</span>
  
<span class="va">samples</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">snpdist.e.long</span>, <span class="va">lab_id.x</span>, <span class="va">lab_id.y</span>, <span class="va">same_snpclust_esco</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id.x"</span>, <span class="st">"lab_id.y"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">snpdist.k.long</span>, <span class="va">lab_id.x</span>, <span class="va">lab_id.y</span>, <span class="va">same_snpclust_kleb</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id.x"</span>, <span class="st">"lab_id.y"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    same_snpclust_esco <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">same_snpclust_esco</span><span class="op">)</span>,
      <span class="cn">FALSE</span>, 
      <span class="va">same_snpclust_esco</span>
    <span class="op">)</span>,
    same_snpclust_kleb <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">same_snpclust_kleb</span><span class="op">)</span>, 
      <span class="cn">FALSE</span>, 
      <span class="va">same_snpclust_kleb</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>

<span class="co"># find null hypothesis values ----------------------------</span>

<span class="va">samples</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">!=</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">esco.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esco.exists.x</span>,
         <span class="va">esco.poppunk.cluster.exists.x</span>, 
         <span class="va">esco.exists.y</span>,
         <span class="va">esco.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esbl.x.and.y</span>,
         <span class="va">same.esco.poppunk.xandy</span>,
         <span class="va">same.esco.xandy</span>,
         <span class="va">same.contig.cluster</span>,
         <span class="va">same_snpclust_esco</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">esco.exists.x</span>, <span class="va">esco.exists.y</span>,
                  <span class="va">esco.poppunk.cluster.exists.x</span>, 
                  <span class="va">esco.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">#filter out those with an esco but no poppunk cluster - they've not been </span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.esco.poppunk.xandy"</span> <span class="op">|</span> 
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
            <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_esco"</span><span class="op">)</span> <span class="op">&amp;</span>
             <span class="va">esco.exists.x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.esco.poppunk.xandy"</span>  <span class="op">|</span> 
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_esco"</span><span class="op">)</span> <span class="op">&amp;</span>
             <span class="va">esco.exists.y</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.y</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same_snpclust"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"SNP cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.contig"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Contig cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.esco.x"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Organism"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"poppunk"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"popPUNK cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"esbl.x.and.y"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ESBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">null</span>

<span class="va">samples</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">!=</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kleb.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">kleb.exists.x</span>,
         <span class="va">kleb.poppunk.cluster.exists.x</span>, 
         <span class="va">kleb.exists.y</span>,
         <span class="va">kleb.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esbl.x.and.y</span>,
         <span class="va">same.kleb.poppunk.xandy</span>,
         <span class="va">same.kleb.xandy</span>,
         <span class="va">same.contig.cluster</span>,
         <span class="va">same_snpclust_kleb</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">kleb.exists.x</span>, <span class="va">kleb.exists.y</span>,
                  <span class="va">kleb.poppunk.cluster.exists.x</span>, 
                  <span class="va">kleb.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">#filter out those with an kleb but no poppunk cluster - they've not been </span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.kleb.poppunk.xandy"</span> <span class="op">|</span> 
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_kleb"</span><span class="op">)</span> <span class="op">&amp;</span>
             <span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.kleb.poppunk.xandy"</span>  <span class="op">|</span> 
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
              <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_kleb"</span><span class="op">)</span> <span class="op">&amp;</span>
             <span class="va">kleb.exists.y</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.y</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same_snpclust"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"SNP cluster"</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.contig"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Contig cluster"</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.kleb.x"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Organism"</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"poppunk"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"popPUNK cluster"</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"esbl.x.and.y"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ESBL"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">null.kleb</span>
  

<span class="co"># within-participant ------------------------------------------</span>

<span class="va">samples</span><span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">pairwise_within</span>

<span class="co"># now plot</span>

<span class="co"># esco</span>

<span class="va">pairwise_within</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">esco.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esco.exists.x</span>,
         <span class="va">esco.poppunk.cluster.exists.x</span>, 
         <span class="va">esco.exists.y</span>,
         <span class="va">esco.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esbl.x.and.y</span>,
         <span class="va">same.esco.poppunk.xandy</span>,
         <span class="va">same.esco.xandy</span>,
         <span class="va">same.contig.cluster</span>,
         <span class="va">same_snpclust_esco</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">esco.exists.x</span>, <span class="va">esco.exists.y</span>,
                  <span class="va">esco.poppunk.cluster.exists.x</span>, 
                  <span class="va">esco.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">#filter out those with an esco but no poppunk cluster - they've not been </span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span>
    <span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.esco.poppunk.xandy"</span> <span class="op">|</span>  
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span> 
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_esco"</span><span class="op">)</span> <span class="op">&amp;</span>
      <span class="va">esco.exists.x</span> <span class="op">&amp;</span> 
      <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.x</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span>
    <span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.esco.poppunk.xandy"</span> <span class="op">|</span> 
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_esco"</span><span class="op">)</span> <span class="op">&amp;</span>
      <span class="va">esco.exists.y</span> <span class="op">&amp;</span> 
      <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.y</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same_snpclust"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"SNP cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.contig"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Contig cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.esco.x"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Organism"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"poppunk"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"popPUNK cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"esbl.x.and.y"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ESBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">ecoli.long</span>





<span class="co"># ------ kleb</span>


<span class="va">pairwise_within</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kleb.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">kleb.exists.x</span>,
         <span class="va">kleb.poppunk.cluster.exists.x</span>, 
         <span class="va">kleb.exists.y</span>,
         <span class="va">kleb.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esbl.x.and.y</span>,
         <span class="va">same.kleb.poppunk.xandy</span>,
         <span class="va">same.kleb.xandy</span>,
         <span class="va">same.contig.cluster</span>,
         <span class="va">same_snpclust_kleb</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">kleb.exists.x</span>, <span class="va">kleb.exists.y</span>,
                  <span class="va">kleb.poppunk.cluster.exists.x</span>, 
                  <span class="va">kleb.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">#filter out those with an esco but no poppunk cluster - they've not been </span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span>
    <span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.kleb.poppunk.xandy"</span> <span class="op">|</span> 
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_kleb"</span><span class="op">)</span> <span class="op">&amp;</span>
      <span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.x</span>
  <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span>
    <span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"same.kleb.poppunk.xandy"</span> <span class="op">|</span> 
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster"</span> <span class="op">|</span>
       <span class="va">name</span> <span class="op">==</span> <span class="st">"same_snpclust_kleb"</span><span class="op">)</span> <span class="op">&amp;</span>
      <span class="va">kleb.exists.y</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.y</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same_snpclust"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"SNP cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.contig"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Contig cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"same.kleb.x"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Organism"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"poppunk"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"popPUNK cluster"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"esbl.x.and.y"</span>, <span class="va">name</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ESBL"</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span>
  <span class="va">kleb.long</span>

<span class="co">#kleb.long %&gt;% </span>
<span class="co">#  mutate(zerod_date = as.Date("2020-01-01") + days(delta_t)) %&gt;% </span>
<span class="co">#  group_by(name) %&gt;% </span>
<span class="co">#  tbr_binom(value, zerod_date, unit = "days",n = 14 ) -&gt; kleb.long</span>

<span class="co">#kleb.long %&gt;% </span>
<span class="co">#  filter(delta_t &gt; 7) %&gt;% </span>
<span class="co">#  ggplot(</span>
<span class="co">#    aes(</span>
<span class="co">#      delta_t,</span>
<span class="co">#      PointEst,</span>
<span class="co">#      group = name,</span>
<span class="co">#      colour = name,</span>
<span class="co">#      fill = name,</span>
<span class="co">#      ymin = Lower,</span>
<span class="co">#      ymax = Upper</span>
<span class="co">#    )) +</span>
<span class="co">#  geom_line() +</span>
<span class="co">#  geom_ribbon(alpha = 0.3, color = NA) +</span>
<span class="co">#  xlim(c(0,200))  +</span>
<span class="co">#  geom_hline(aes(yintercept = prop, color = name), data = null.kleb)</span>
 <span class="co"># plot</span>

<span class="va">varorder</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Organism"</span>, <span class="st">"popPUNK cluster"</span>, <span class="st">"Contig cluster"</span>,
             <span class="st">"SNP cluster"</span><span class="op">)</span>

<span class="va">ecoli.long</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span>,
                      <span class="st">"ESBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    <span class="va">delta_t</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>,
           <span class="co">#   size = 0.5,</span>
         <span class="co">#     alpha = 0.2, </span>
              color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">null</span><span class="op">$</span><span class="va">prop</span><span class="op">[</span><span class="va">null</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"Organism"</span><span class="op">]</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span>,
             alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
<span class="co">#  scale_color_lancet() +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Time/days"</span>, y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">e</span>
<span class="co">#theme(legend.position = "right")-&gt; e</span>

<span class="va">kleb.long</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span>,
                      <span class="st">"ESBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    <span class="va">delta_t</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>,
           <span class="co">#   size = 0.5,</span>
         <span class="co">#     alpha = 0.2, </span>
              color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">null.kleb</span><span class="op">$</span><span class="va">prop</span><span class="op">[</span><span class="va">null.kleb</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"Organism"</span><span class="op">]</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span>,
             alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
<span class="co">#  scale_color_lancet() +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Time/days"</span>, y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">k</span>



<span class="va">ecoli.long</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span>
         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
     <span class="va">name</span> <span class="op">==</span>  <span class="st">"Contig cluster"</span> <span class="op">~</span> <span class="st">"Contig\ncluster"</span>,
     <span class="va">name</span> <span class="op">==</span> <span class="st">"popPUNK cluster"</span> <span class="op">~</span> <span class="st">"popPUNK\ncluster"</span>,
    <span class="va">name</span> <span class="op">==</span> <span class="st">"SNP cluster"</span> <span class="op">~</span><span class="st">"SNP&lt;6"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    <span class="va">delta_t</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
    group <span class="op">=</span> <span class="va">name</span>,
    color <span class="op">=</span> <span class="va">name</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">+</span>
              <span class="co">#size = 0.5,</span>
              <span class="co">#alpha = 0.2)  +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">prop</span>, color <span class="op">=</span> <span class="va">name</span><span class="op">)</span>,
         <span class="co">#    data = null[null$name %in% </span>
         <span class="co">#                  c("ESBL-contig",</span>
          <span class="co">#                   "popPUNK",</span>
          <span class="co">#                   "SNP&lt;5"), ], </span>
         data <span class="op">=</span> <span class="va">null</span> <span class="op">%&gt;%</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> 
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
     <span class="va">name</span> <span class="op">==</span>  <span class="st">"Contig cluster"</span> <span class="op">~</span> <span class="st">"Contig\ncluster"</span>,
     <span class="va">name</span> <span class="op">==</span> <span class="st">"popPUNK cluster"</span> <span class="op">~</span> <span class="st">"popPUNK\ncluster"</span>,
    <span class="va">name</span> <span class="op">==</span> <span class="st">"SNP cluster"</span> <span class="op">~</span><span class="st">"SNP&lt;6"</span><span class="op">)</span>
                  <span class="op">)</span>, 
         linetype <span class="op">=</span> <span class="st">"dashed"</span>,
         alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Time/days"</span>, y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">e2</span>
<span class="co"># theme(legend.position = "right") -&gt; e2</span>

<span class="co">## kleb ------------</span>

<span class="va">kleb.long</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span>
         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
     <span class="va">name</span> <span class="op">==</span>  <span class="st">"Contig cluster"</span> <span class="op">~</span> <span class="st">"Contig\ncluster"</span>,
     <span class="va">name</span> <span class="op">==</span> <span class="st">"popPUNK cluster"</span> <span class="op">~</span> <span class="st">"popPUNK\ncluster"</span>,
    <span class="va">name</span> <span class="op">==</span> <span class="st">"SNP cluster"</span> <span class="op">~</span><span class="st">"SNP&lt;6"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    <span class="va">delta_t</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
    group <span class="op">=</span> <span class="va">name</span>,
    color <span class="op">=</span> <span class="va">name</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">+</span>
              <span class="co">#size = 0.5,</span>
              <span class="co">#alpha = 0.2)  +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">prop</span>, color <span class="op">=</span> <span class="va">name</span><span class="op">)</span>,
         <span class="co">#    data = null[null$name %in% </span>
         <span class="co">#                  c("ESBL-contig",</span>
          <span class="co">#                   "popPUNK",</span>
          <span class="co">#                   "SNP&lt;5"), ], </span>
         data <span class="op">=</span> <span class="va">null</span> <span class="op">%&gt;%</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Contig cluster"</span>,
                      <span class="st">"popPUNK cluster"</span>,
                      <span class="st">"SNP cluster"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> 
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
     <span class="va">name</span> <span class="op">==</span>  <span class="st">"Contig cluster"</span> <span class="op">~</span> <span class="st">"Contig\ncluster"</span>,
     <span class="va">name</span> <span class="op">==</span> <span class="st">"popPUNK cluster"</span> <span class="op">~</span> <span class="st">"popPUNK\ncluster"</span>,
    <span class="va">name</span> <span class="op">==</span> <span class="st">"SNP cluster"</span> <span class="op">~</span><span class="st">"SNP&lt;6"</span><span class="op">)</span>
                  <span class="op">)</span>, 
         linetype <span class="op">=</span> <span class="st">"dashed"</span>,
         alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">180</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/viridis_pal.html">viridis_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Time/days"</span>, y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">k2</span>



<span class="va">samples</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">esco.exists.x</span> <span class="op">&amp;</span> <span class="va">esco.exists.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">#filter out those with an esco but no poppunk cluster - they've not been </span>
    <span class="co"># sequenced</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">esco.exists.x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">esco.exists.y</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.y</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
    <span class="co">#filter(!(kleb.exists.y &amp; !kleb.poppunk.cluster.exists.y))  %&gt;% </span>
    <span class="co"># filter(!(kleb.exists.x &amp; !kleb.poppunk.cluster.exists.x))  %&gt;% </span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span>
        within_patient <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span>,
                                 <span class="st">"within"</span>,
                                 <span class="st">"between"</span><span class="op">)</span>,
        same_pp_and_esbl_contig <span class="op">=</span> 
            <span class="op">(</span><span class="va">same.contig.cluster</span> <span class="op">&amp;</span> <span class="va">same.esco.poppunk.xandy</span><span class="op">)</span>,
        same_pp_only <span class="op">=</span> <span class="op">(</span><span class="va">same.esco.poppunk.xandy</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">same.contig.cluster</span><span class="op">)</span>,
        same.contig.cluster_only <span class="op">=</span> <span class="op">(</span><span class="va">same.contig.cluster</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">same.esco.poppunk.xandy</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">within_patient</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">within_patient</span>, <span class="va">name</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">within_patient</span>,<span class="va">name</span><span class="op">)</span>, names_from <span class="op">=</span> <span class="va">value</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster_only"</span> <span class="op">~</span> <span class="st">"ESBL-contig only"</span>,
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same_pp_only"</span> <span class="op">~</span> <span class="st">"popPUNK only"</span>,
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same_pp_and_esbl_contig"</span> <span class="op">~</span> 
               <span class="st">"Both"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fish <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>,  <span class="op">~</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
        x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">name</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span>,
        y <span class="op">=</span> <span class="va">estimate</span>,
        ymin <span class="op">=</span> <span class="va">conf.low</span>,
        ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Odds ratio"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">or.plot</span>
   <span class="co">#theme(axis.text.x = element_text(angle = 90, hjust = 1)) -&gt; or.plot</span>

<span class="co"># or plot kleb</span>


<span class="va">samples</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="va">kleb.exists.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">#filter out those with an esco but no poppunk cluster - they've not been </span>
    <span class="co"># sequenced</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">kleb.exists.y</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.y</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
    <span class="co">#filter(!(kleb.exists.y &amp; !kleb.poppunk.cluster.exists.y))  %&gt;% </span>
    <span class="co"># filter(!(kleb.exists.x &amp; !kleb.poppunk.cluster.exists.x))  %&gt;% </span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span>
        within_patient <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span>,
                                 <span class="st">"within"</span>,
                                 <span class="st">"between"</span><span class="op">)</span>,
        same_pp_and_esbl_contig <span class="op">=</span> 
            <span class="op">(</span><span class="va">same.contig.cluster</span> <span class="op">&amp;</span> <span class="va">same.kleb.poppunk.xandy</span><span class="op">)</span>,
        same_pp_only <span class="op">=</span> <span class="op">(</span><span class="va">same.kleb.poppunk.xandy</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">same.contig.cluster</span><span class="op">)</span>,
        same.contig.cluster_only <span class="op">=</span> <span class="op">(</span><span class="va">same.contig.cluster</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">same.kleb.poppunk.xandy</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">within_patient</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">within_patient</span>, <span class="va">name</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">within_patient</span>,<span class="va">name</span><span class="op">)</span>, names_from <span class="op">=</span> <span class="va">value</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same.contig.cluster_only"</span> <span class="op">~</span> <span class="st">"ESBL-contig only"</span>,
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same_pp_only"</span> <span class="op">~</span> <span class="st">"popPUNK only"</span>,
             <span class="va">name</span> <span class="op">==</span> <span class="st">"same_pp_and_esbl_contig"</span> <span class="op">~</span> 
               <span class="st">"Both"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fish <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>,  <span class="op">~</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
        x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">name</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span>,
        y <span class="op">=</span> <span class="va">estimate</span>,
        ymin <span class="op">=</span> <span class="va">conf.low</span>,
        ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Odds ratio"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">or.plot.kleb</span>

<span class="co">###</span>


<span class="va">e</span> <span class="op">+</span> <span class="va">k</span> <span class="op">+</span> <span class="va">e2</span> <span class="op">+</span> <span class="va">k2</span> <span class="op">+</span> <span class="va">or.plot</span> <span class="op">+</span> <span class="va">or.plot.kleb</span>  <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, guides <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">autocorrelation_plot</span>


<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F3_autocorrelation.pdf"</span><span class="op">)</span>,
         <span class="va">autocorrelation_plot</span>,
         width <span class="op">=</span> <span class="fl">9</span>,
         height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F3_autocorrelation.svg"</span><span class="op">)</span>,
         <span class="va">autocorrelation_plot</span>,
         width <span class="op">=</span> <span class="fl">9</span>, 
         height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">autocorrelation_plot</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/autocorrelation-plot-1.png" alt="Within participant correlation of organism, lineage, mobile genetic element (MGE) and clone. A-B show proportions of participants that have a detectible E. coli (A), K. pneumoniae (B) at t time t=0 and the same organism at a time t later. Dashed lines show the proportion of samples in the collection that would be expected to have the same organism by chance: the proportion of between-participant samples that have the same organism. C shows (E. coli only) and D (for K. pneumoniae complex) the proportion of participants who are colonised with at time t=0 and the proportion of those who have the same lineage (as defined by popPUNK cluster), clone (as defined by &lt;6 SNPs), or mobile genetic element (defined by ESBl-contig cluster) detectible a at time t later. Dashed lined again show the between-participant proportion of samples that contain the same lineage, clone or MGE to show the chance of obtaining any result ny chance. Fitted lines are from a nonparametric LOESS fit with 95% confidence intervals. D shows odds ratios of any within-participant E. coli pair containing the same popPUNK cluster only, ESBL-contig cluster, or both, compared to between-participant pairs, and E the same data for K. pneumoniae. It is more likely that both lineage (popPUNK cluster) and MGE (ESBL-cluster) are conserved together than either seperately, suggesting that the lineage-MGE combination is the conserved unit within this system." width="864"><p class="caption">
Within participant correlation of organism, lineage, mobile genetic element (MGE) and clone. A-B show proportions of participants that have a detectible E. coli (A), K. pneumoniae (B) at t time t=0 and the same organism at a time t later. Dashed lines show the proportion of samples in the collection that would be expected to have the same organism by chance: the proportion of between-participant samples that have the same organism. C shows (E. coli only) and D (for K. pneumoniae complex) the proportion of participants who are colonised with at time t=0 and the proportion of those who have the same lineage (as defined by popPUNK cluster), clone (as defined by &lt;6 SNPs), or mobile genetic element (defined by ESBl-contig cluster) detectible a at time t later. Dashed lined again show the between-participant proportion of samples that contain the same lineage, clone or MGE to show the chance of obtaining any result ny chance. Fitted lines are from a nonparametric LOESS fit with 95% confidence intervals. D shows odds ratios of any within-participant E. coli pair containing the same popPUNK cluster only, ESBL-contig cluster, or both, compared to between-participant pairs, and E the same data for K. pneumoniae. It is more likely that both lineage (popPUNK cluster) and MGE (ESBL-cluster) are conserved together than either seperately, suggesting that the lineage-MGE combination is the conserved unit within this system.
</p>
</div>
</div>
<div id="hospital-associated-lineages-and-mge" class="section level3">
<h3 class="hasAnchor">
<a href="#hospital-associated-lineages-and-mge" class="anchor"></a>Hospital associated lineages and MGE</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">clusts</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">clusts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">clusts</span><span class="op">$</span><span class="va">lane</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_esco</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span>
    <span class="va">clusts</span><span class="op">[</span><span class="st">"hosp_assoc"</span><span class="op">]</span>, 
    width <span class="op">=</span> <span class="fl">0.05</span>, 
    color <span class="op">=</span> <span class="cn">NA</span>, 
    font.size <span class="op">=</span> <span class="fl">3</span>,
    colnames <span class="op">=</span> <span class="cn">FALSE</span>
   <span class="co"># colnames_angle = 90, </span>
  <span class="co">#  colnames_position = "top", </span>
  <span class="co">#  colnames_offset_y = 10,</span>
  <span class="op">)</span>  <span class="op">+</span>
 <span class="co"># ylim(c(0,500)) +</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/geom-hilight.html">geom_hilight</a></span><span class="op">(</span>node <span class="op">=</span> <span class="fl">727</span>, fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"grey86"</span>, <span class="st">"black"</span>, <span class="st">"grey65"</span><span class="op">)</span>,
                    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Community"</span>,
                              <span class="st">"In hospital"</span>,
                              <span class="st">"Post-discharge"</span><span class="op">)</span>,
                    na.translate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hospassoc.tree.esco</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/ggtree.html">ggtree</a></span><span class="op">(</span><span class="fu">treeio</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/treeio/reference/tree_subset.html">tree_subset</a></span><span class="op">(</span><span class="va">btESBL_coregene_tree_kleb</span>, <span class="fl">210</span>, 
                           levels_back <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html">gheatmap</a></span><span class="op">(</span>
    <span class="va">clusts</span><span class="op">[</span><span class="st">"hosp_assoc"</span><span class="op">]</span>, 
    width <span class="op">=</span> <span class="fl">0.05</span>, 
    color <span class="op">=</span> <span class="cn">NA</span>, 
    font.size <span class="op">=</span> <span class="fl">3</span>, 
    colnames <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="co">#  colnames_angle = 90, </span>
  <span class="co">#  colnames_position = "top", </span>
  <span class="co">#  colnames_offset_y = 10,</span>
  <span class="op">)</span>  <span class="op">+</span>
  <span class="co">#ylim(c(0,220)) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"grey86"</span>, <span class="st">"black"</span>, <span class="st">"grey65"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"grey86"</span>, <span class="st">"black"</span>, <span class="st">"grey65"</span><span class="op">)</span>,
                    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Community"</span>,
                              <span class="st">"In hospital"</span>,
                              <span class="st">"Post-discharge"</span><span class="op">)</span>,
                    na.translate <span class="op">=</span> <span class="cn">FALSE</span>
                              <span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hospassoc.tree.kleb</span>
<span class="co">#&gt; Scale for 'y' is already present. Adding another scale for 'y', which will</span>
<span class="co">#&gt; replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>
<span class="co">#&gt; Scale for 'fill' is already present. Adding another scale for 'fill', which</span>
<span class="co">#&gt; will replace the existing scale.</span>


<span class="va">clusts</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    total_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    total_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">!=</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    clust_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    clust_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">!=</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    total_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">total_in_hosp</span><span class="op">)</span> <span class="op">-</span> <span class="va">clust_in_hosp</span>,
    total_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">total_not_in_hosp</span><span class="op">)</span> <span class="op">-</span> <span class="va">clust_not_in_hosp</span>,
    pval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clust_in_hosp</span>, <span class="va">total_in_hosp</span>, <span class="va">clust_not_in_hosp</span>, <span class="va">total_not_in_hosp</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>
    <span class="op">)</span>, simulate.p.value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>clustr <span class="op">=</span> <span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>log_pval <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">df.manhattan.popPUNK</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df.manhattan.popPUNK</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">clustr</span>, <span class="va">log_pval</span>, color <span class="op">=</span> <span class="va">log_pval</span> <span class="op">&gt;</span> 
                                   <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.05</span> <span class="op">/</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.manhattan.popPUNK</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.05</span> <span class="op">/</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.manhattan.popPUNK</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"none"</span>,
    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"-log(p)"</span>, x <span class="op">=</span> <span class="st">"popPUNK cluster"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">(</span><span class="fl">23</span><span class="op">*</span><span class="fl">1.3</span><span class="op">)</span>, y <span class="op">=</span>  <span class="op">(</span><span class="fl">3.66722</span> <span class="op">-</span> <span class="fl">3.66722</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, 
                   xend <span class="op">=</span> <span class="fl">23</span> <span class="op">+</span> <span class="fl">23</span><span class="op">*</span><span class="fl">0.3</span><span class="op">*</span><span class="fl">0.1</span>, yend <span class="op">=</span> <span class="fl">3.66722</span> <span class="op">-</span> <span class="fl">0.1</span><span class="op">*</span><span class="fl">3.66722</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,
               arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">manhattanplot_popPUNK</span>
 <span class="co"># </span>

<span class="co">## -- esbl clusters</span>

<span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>,
            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">clusts_esbl</span>


<span class="va">clusts_esbl</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    total_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    total_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">!=</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    clust_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    clust_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">!=</span> <span class="st">"in_hospital"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    total_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">total_in_hosp</span><span class="op">)</span> <span class="op">-</span> <span class="va">clust_in_hosp</span>,
    total_not_in_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">total_not_in_hosp</span><span class="op">)</span> <span class="op">-</span> <span class="va">clust_not_in_hosp</span>,
    pval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clust_in_hosp</span>, <span class="va">total_in_hosp</span>, <span class="va">clust_not_in_hosp</span>, <span class="va">total_not_in_hosp</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>
    <span class="op">)</span>, simulate.p.value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>log_pval <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">df.manhattan.esbl</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df.manhattan.esbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">clstr_name</span>, <span class="va">log_pval</span>, color <span class="op">=</span> <span class="va">log_pval</span> <span class="op">&gt;</span> 
                                   <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.05</span> <span class="op">/</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.manhattan.popPUNK</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.05</span> <span class="op">/</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.manhattan.popPUNK</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"none"</span>,
    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"-log(p)"</span>, x <span class="op">=</span> <span class="st">"Contig cluster"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">(</span><span class="fl">27</span><span class="op">*</span><span class="fl">1.3</span><span class="op">)</span>, y <span class="op">=</span>  <span class="op">(</span><span class="fl">3.680</span> <span class="op">-</span> <span class="fl">3.680</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, 
                   xend <span class="op">=</span> <span class="fl">27</span> <span class="op">+</span> <span class="fl">27</span><span class="op">*</span><span class="fl">0.3</span><span class="op">*</span><span class="fl">0.1</span>, yend <span class="op">=</span> <span class="fl">3.680</span> <span class="op">-</span> <span class="fl">0.1</span><span class="op">*</span><span class="fl">3.680</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,
               arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">manhattanplot_esbl</span>
 <span class="co"># </span>

<span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">hospassoc.tree.esco</span> <span class="op">|</span>
  <span class="va">hospassoc.tree.kleb</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> 
  <span class="op">(</span><span class="va">manhattanplot_popPUNK</span> <span class="op">/</span>
  <span class="va">manhattanplot_esbl</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">1</span><span class="op">)</span>,
              guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hosp_assoc_lineages</span>

<span class="va">hosp_assoc_lineages</span></code></pre></div>
<p><img src="analysis_files/figure-html/hosp-assoc-lineages-1.png" width="864"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F4_hosp_assoc_lineages.pdf"</span><span class="op">)</span>,
         <span class="va">hosp_assoc_lineages</span>,
         width <span class="op">=</span> <span class="fl">9</span>,
         height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F4_hosp_assoc_lineages.svg"</span><span class="op">)</span>,
         <span class="va">hosp_assoc_lineages</span>,
         width <span class="op">=</span> <span class="fl">9</span>, 
         height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="construct-and-fit-snp-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#construct-and-fit-snp-clusters" class="anchor"></a>Construct and fit SNP-clusters</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="va">make_cluster_pairwise_comparison_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pairwise_snp_df</span>,
                                                <span class="va">metadata_df</span>,
                                                <span class="va">cut_tree_vect</span>,
                                                <span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cluster_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect</span><span class="op">[</span><span class="va">cut_tree_vect</span> <span class="op">==</span> <span class="va">n</span><span class="op">]</span><span class="op">)</span>
  <span class="va">pairwise_snp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">pairwise_snp_df</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">pairwise_snp_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pairwise_snp_df</span><span class="op">$</span><span class="va">sample</span>
  <span class="va">pairwise_snp_df</span><span class="op">[</span><span class="va">cluster_samples</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="va">cluster_samples</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sample</span> <span class="op">!=</span> <span class="va">name</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">d</span>
  
  <span class="va">d</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sort</span><span class="op">)</span>, MARGIN <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="op">]</span> <span class="op">-&gt;</span> <span class="va">d</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span>, <span class="st">"sample.y"</span>, <span class="st">"snpdist"</span><span class="op">)</span>
  <span class="va">d</span><span class="op">$</span><span class="va">sample.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="st">"_"</span>, <span class="va">d</span><span class="op">$</span><span class="va">sample.x</span><span class="op">)</span>
  <span class="va">d</span><span class="op">$</span><span class="va">sample.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="st">"_"</span>, <span class="va">d</span><span class="op">$</span><span class="va">sample.y</span><span class="op">)</span>
  
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">d</span>,
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
      <span class="va">metadata_df</span>,
      <span class="va">lane</span>,
      <span class="va">pid</span>,
      <span class="va">arm</span>,
      <span class="va">visit</span>,
      <span class="va">enroll_date</span>,
      <span class="va">hospoutcomedate</span>,
      <span class="va">data_date</span>
    <span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
        <span class="va">metadata_df</span>,
        <span class="va">lane</span>,
        <span class="va">pid</span>,
        <span class="va">arm</span>,
        <span class="va">visit</span>,
        <span class="va">enroll_date</span>,
        <span class="va">hospoutcomedate</span>,
        <span class="va">data_date</span>
      <span class="op">)</span>,
      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">d</span>
  <span class="va">d</span><span class="op">$</span><span class="va">pair</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">sample.x</span>, <span class="st">"-"</span>, <span class="va">d</span><span class="op">$</span><span class="va">sample.y</span><span class="op">)</span>
  <span class="va">d</span><span class="op">$</span><span class="va">cluster_number</span> <span class="op">&lt;-</span> <span class="va">n</span>
  <span class="va">d</span><span class="op">$</span><span class="va">cluster_name</span> <span class="op">&lt;-</span> <span class="va">n</span>
  <span class="va">d</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span> <span class="op">~</span> <span class="st">"within"</span>,
                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"between"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>   <span class="va">d</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
  
<span class="op">}</span>


<span class="va">make_all_clusters_pairwise_comparison_df</span>  <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">pairwise_snp_df</span>,
           <span class="va">metadata_df</span>,
           <span class="va">cut_tree_vect</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">cut_tree_vect</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">#    print(i)</span>
      <span class="co">#  print(i)</span>
      <span class="fu">make_cluster_pairwise_comparison_df</span><span class="op">(</span><span class="va">pairwise_snp_df</span>,
                                          <span class="va">metadata_df</span>,
                                          <span class="va">cut_tree_vect</span>,
                                          <span class="va">i</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
      
    <span class="op">}</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">out</span><span class="op">)</span><span class="op">)</span>
    
    
  <span class="op">}</span>


<span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hclust_snpdists.e</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hclust_snpdists.e</span>, h <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cut_tree_vect.e</span>

<span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hclust_snpdists.k</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hclust_snpdists.k</span>, h <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cut_tree_vect.k</span>

<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
            lq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.25</span><span class="op">)</span>,
            uq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;     med    lq    uq</span>
<span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     2     2     5</span>

<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
            lq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.25</span><span class="op">)</span>,
            uq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;     med    lq    uq</span>
<span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     2     2     3</span>
  
<span class="fu">make_all_clusters_pairwise_comparison_df</span><span class="op">(</span>
  <span class="va">btESBL_snpdists_esco</span>,
  <span class="va">btESBL_sequence_sample_metadata</span>,
  <span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairwise_snpclust.e</span>


<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span> ,
                          by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lane.x</span> <span class="op">!=</span> <span class="va">lane.y</span>,
           <span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane.x</span>, <span class="va">lane.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Same Patient"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lane.x</span>,
           to <span class="op">=</span> <span class="va">lane.y</span><span class="op">)</span>,
  <span class="va">pairwise_snpclust.e</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample.x</span>, <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sample.x</span>,
           to <span class="op">=</span> <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"SNPs &lt;6"</span><span class="op">)</span>

<span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.e</span>




  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span>,
            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    hosp_assoc <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"community"</span> <span class="op">~</span> <span class="st">"Community"</span>,
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span> <span class="op">~</span> <span class="st">"In hospital"</span>,
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"recent_dc"</span> <span class="op">~</span> <span class="st">"Post discharge"</span><span class="op">)</span>,
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">lane</span>, .before <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> 
    <span class="va">vertices.e</span>

<span class="va">edges.e</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sortvar <span class="op">=</span> <span class="fu">map2_chr</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.x</span>,<span class="va">.y</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sortvar</span>,<span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sortvar</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">from</span>,<span class="va">to</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># remove those with missing metadata</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span>
    <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span>,
             by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span>
    <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span>,
             by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.e</span>


<span class="va">gr.e</span> <span class="op">&lt;-</span> <span class="fu">graph_from_data_frame</span><span class="op">(</span><span class="va">edges.e</span>, directed <span class="op">=</span> <span class="cn">FALSE</span>, vertices <span class="op">=</span> <span class="va">vertices.e</span><span class="op">)</span>

<span class="fu">ggraph</span><span class="op">(</span><span class="va">gr.e</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_edge_fan</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_node_point</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">hosp_assoc</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">#  facet_edges(~ type) + </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>,<span class="st">"black"</span>,<span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>edge_colour<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
         fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> 
  <span class="va">snp_network_plot.esco</span>

<span class="co"># kleb</span>

<span class="fu">make_all_clusters_pairwise_comparison_df</span><span class="op">(</span>
  <span class="va">btESBL_snpdists_kleb</span>,
  <span class="va">btESBL_sequence_sample_metadata</span>,
  <span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairwise_snpclust.k</span>


<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span> ,
                          by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lane.x</span> <span class="op">!=</span> <span class="va">lane.y</span>,
           <span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane.x</span>, <span class="va">lane.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Same Patient"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lane.x</span>,
           to <span class="op">=</span> <span class="va">lane.y</span><span class="op">)</span>,
  <span class="va">pairwise_snpclust.k</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample.x</span>, <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sample.x</span>,
           to <span class="op">=</span> <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"SNPs &lt;6"</span><span class="op">)</span>

<span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.k</span>




  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span>,
            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    hosp_assoc <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"community"</span> <span class="op">~</span> <span class="st">"Community"</span>,
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span> <span class="op">~</span> <span class="st">"In hospital"</span>,
      <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"recent_dc"</span> <span class="op">~</span> <span class="st">"Post discharge"</span><span class="op">)</span>,
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">lane</span>, .before <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> 
    <span class="va">vertices.k</span>

<span class="va">edges.k</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sortvar <span class="op">=</span> <span class="fu">map2_chr</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.x</span>,<span class="va">.y</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sortvar</span>,<span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sortvar</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">from</span>,<span class="va">to</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># remove those with missing metadata</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span>
    <span class="va">vertices.k</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span>
    <span class="va">vertices.k</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.k</span>


<span class="va">gr.k</span> <span class="op">&lt;-</span> <span class="fu">graph_from_data_frame</span><span class="op">(</span><span class="va">edges.k</span>, directed <span class="op">=</span> <span class="cn">FALSE</span>, vertices <span class="op">=</span> <span class="va">vertices.k</span><span class="op">)</span>

<span class="fu">ggraph</span><span class="op">(</span><span class="va">gr.k</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_edge_fan</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_node_point</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">hosp_assoc</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#  facet_edges(~ type) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>edge_colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
         fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>  <span class="op">-&gt;</span>
  <span class="va">snp_network_plot.kleb</span>


<span class="op">(</span><span class="va">snp_network_plot.esco</span> <span class="op">+</span> 
  <span class="va">snp_network_plot.kleb</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">&amp;</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>, 
        plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">22</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">snp_networks</span>
<span class="va">snp_networks</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/snp-clusts-1.png" alt="Network plot of SNP-clusters (i.e. putative transmission clusters) for E. coli (A) and K. pneumoniae (B) showing that putative transmission clusters are not purely hospital associated. Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by five or fewer SNPs. The plot shows that most samples are not members of a SNP-cluster; that most SNP clusters are made up of samples from different participants (rather than multiple samples from the same participant); and that SNP-clusters are not strongly hospital-associated (i.e. they contain black, white, and grey points)." width="1267.2"><p class="caption">
Network plot of SNP-clusters (i.e. putative transmission clusters) for E. coli (A) and K. pneumoniae (B) showing that putative transmission clusters are not purely hospital associated. Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by five or fewer SNPs. The plot shows that most samples are not members of a SNP-cluster; that most SNP clusters are made up of samples from different participants (rather than multiple samples from the same participant); and that SNP-clusters are not strongly hospital-associated (i.e. they contain black, white, and grey points).
</p>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F4snp_networks.pdf"</span><span class="op">)</span>,
         <span class="va">snp_networks</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>,
         height <span class="op">=</span> <span class="fl">7.5</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/F4snp_networks.svg"</span><span class="op">)</span>,
         <span class="va">snp_networks</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>, 
         height <span class="op">=</span> <span class="fl">7.5</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="misc-snp-cluster-stats" class="section level3">
<h3 class="hasAnchor">
<a href="#misc-snp-cluster-stats" class="anchor"></a>Misc SNP cluster stats</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## calculate stats about snpclusts</span>

<span class="co"># how many in snp clusters are within vs between?</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pairwise_snpclust.e</span><span class="op">$</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pairwise_snpclust.e</span><span class="op">$</span><span class="va">pid.y</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; FALSE  TRUE </span>
<span class="co">#&gt;   165    10</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pairwise_snpclust.k</span><span class="op">$</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pairwise_snpclust.k</span><span class="op">$</span><span class="va">pid.y</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; FALSE  TRUE </span>
<span class="co">#&gt;     5     7</span>

<span class="co"># what prop of clustered isolates are community vs hosp</span>

<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_esco</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"esco"</span>,
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_kleb</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"kleb"</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"lane"</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">hosp_assoc</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">species</span>,
              names_from <span class="op">=</span> <span class="va">hosp_assoc</span>,
              values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt; # Groups:   species [2]</span>
<span class="co">#&gt;   species community in_hospital recent_dc  `NA`</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;       &lt;int&gt;     &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 esco           54          19        77     1</span>
<span class="co">#&gt; 2 kleb            4           7        10    NA</span>

<span class="co"># and for non SNP-clustered </span>

<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_esco</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"esco"</span>,
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_kleb</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"kleb"</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"lane"</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">hosp_assoc</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">species</span>,
              names_from <span class="op">=</span> <span class="va">hosp_assoc</span>,
              values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt; # Groups:   species [2]</span>
<span class="co">#&gt;   species community in_hospital recent_dc  `NA`</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;int&gt;       &lt;int&gt;     &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 esco          117          59       145     1</span>
<span class="co">#&gt; 2 kleb           70          26        85     1</span></code></pre></div>
</div>
<div id="snp-cutoff-sensitivity-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#snp-cutoff-sensitivity-analysis" class="anchor"></a>SNP cutoff sensitivity analysis</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># sensitivity analysis of snp cutoffs</span>

<span class="va">btESBL_snpdists_esco</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"sample"</span>,
         <span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"name"</span>,
         <span class="st">"snpdist_esco"</span> <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.x"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.y"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lab_id.x</span>, <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">snpdist.e.long</span>



<span class="va">btESBL_snpdists_kleb</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"sample"</span>,
         <span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"name"</span>,
         <span class="st">"snpdist_kleb"</span> <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.x"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.x"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"lab_id.y"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample.y"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lab_id.x</span>, <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>  <span class="op">-&gt;</span> <span class="va">snpdist.k.long</span>

<span class="co"># make list-column df -----------------------------------------------------</span>


<span class="va">btESBL_stoolESBL</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">btESBL_stoolorgs</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ESBL</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lab_id</span>, <span class="va">organism</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="st">"lab_id"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>orgs <span class="op">=</span> <span class="va">organism</span><span class="op">)</span> <span class="op">%&gt;%</span>
 <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">supplier_name</span>, <span class="va">Cluster</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>pp_clust <span class="op">=</span> <span class="va">Cluster</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">btESBL_contigclusters</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span> , <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">supplier_name</span>, <span class="va">clstr_name</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>contig_clust <span class="op">=</span> <span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">supplier_name</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id"</span> <span class="op">=</span> <span class="st">"supplier_name"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>lanes <span class="op">=</span> <span class="va">lane</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>
<span class="co">#&gt; Joining, by = "lane"</span>

<span class="va">samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lab_id.x</span> <span class="op">!=</span> <span class="va">lab_id.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>delta_t <span class="op">=</span>
           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">delta_t</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>
<span class="co"># compare presence absence of clusters</span>

<span class="va">samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>esbl.x.and.y <span class="op">=</span> <span class="va">ESBL.x</span> <span class="op">==</span> <span class="st">"Positive"</span> <span class="op">&amp;</span>
           <span class="va">ESBL.y</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#compare ESCO poppunk clusters between x and y</span>
  <span class="co"># and add variables for e coli cluster and presence/absence</span>
  <span class="co"># e coli to later remove isolates that weren't sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    same.esco.poppunk.xandy <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">pp_clust.x</span>,
           <span class="va">pp_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flags for existence of poppunk clusters</span>
    esco.poppunk.cluster.exists.x <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    esco.poppunk.cluster.exists.y <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.y</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"E"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flag for existence of esco</span>
    esco.exists.x <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"coli"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    esco.exists.y <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.y</span>,  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"coli"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    same.esco.xandy <span class="op">=</span> <span class="va">esco.exists.x</span> <span class="op">&amp;</span> <span class="va">esco.exists.y</span>,
    <span class="co"># contig clusters</span>
    same.contig.cluster <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">contig_clust.x</span>,
           <span class="va">contig_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">clstr_name</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">clstr_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># same but for klebs</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    same.kleb.poppunk.xandy <span class="op">=</span>
      <span class="fu">map2</span><span class="op">(</span><span class="va">pp_clust.x</span>,
           <span class="va">pp_clust.y</span>,
           <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span> <span class="op">%in%</span>
             <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.y</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flags for existence of poppunk clusters</span>
    kleb.poppunk.cluster.exists.x <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    kleb.poppunk.cluster.exists.y <span class="op">=</span>
      <span class="fu">map</span><span class="op">(</span><span class="va">pp_clust.y</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"K"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">Cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">any</span><span class="op">)</span>,
    <span class="co"># flag for existence of kleb</span>
    kleb.exists.x <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Klebsiella pneumoniae"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    kleb.exists.y <span class="op">=</span>
      <span class="fu">map_lgl</span><span class="op">(</span><span class="va">orgs.y</span>,  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Klebsiella pneumoniae"</span>, <span class="va">.x</span><span class="op">$</span><span class="va">organism</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    same.kleb.xandy <span class="op">=</span> <span class="va">kleb.exists.x</span> <span class="op">&amp;</span> <span class="va">kleb.exists.y</span><span class="op">)</span> <span class="op">-&gt;</span>
  <span class="va">samples</span>

<span class="co"># merge in snpdist clusters</span>

<span class="va">samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">snpdist.e.long</span>, <span class="va">lab_id.x</span>, <span class="va">lab_id.y</span>, <span class="va">snpdist_esco</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id.x"</span>, <span class="st">"lab_id.y"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">snpdist.k.long</span>, <span class="va">lab_id.x</span>, <span class="va">lab_id.y</span>, <span class="va">snpdist_kleb</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lab_id.x"</span>, <span class="st">"lab_id.y"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">samples</span>

<span class="va">samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairwise_within</span>


<span class="va">pairwise_within</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">esco.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">esco.exists.x</span>,
         <span class="va">esco.poppunk.cluster.exists.x</span>,
         <span class="va">esco.exists.y</span>,
         <span class="va">esco.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">snpdist_esco</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">esco.exists.x</span>, <span class="va">esco.exists.y</span>,
                  <span class="va">esco.poppunk.cluster.exists.x</span>,
                  <span class="va">esco.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#filter out those with an esco but no poppunk cluster - they've not been</span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="op">(</span><span class="va">esco.exists.x</span> <span class="op">&amp;</span>
      <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.x</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">esco.exists.y</span> <span class="op">&amp;</span>
      <span class="op">!</span><span class="va">esco.poppunk.cluster.exists.y</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ecoli.long</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">newcolvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"snpdist_"</span>,<span class="va">i</span><span class="op">)</span>
  <span class="va">ecoli.long</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">newcolvar</span><span class="op">}</span><span class="op">}</span> <span class="op">:=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span>
      <span class="va">value</span> <span class="op">&lt;=</span> <span class="va">i</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ecoli.long</span>
<span class="op">}</span>

<span class="va">ecoli.long</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">delta_t</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"snpdist"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">delta_t</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>snpdist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"snpdist_"</span>,<span class="st">""</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">delta_t</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">snpdist</span>, group <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">150</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.13</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.02</span>,<span class="fl">0.04</span>,<span class="fl">0.06</span>,<span class="fl">0.08</span>,<span class="fl">0.1</span>,<span class="fl">0.12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"SNP\ndistance"</span>,
       x <span class="op">=</span> <span class="st">"Time/days"</span>,
       y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a</span>



<span class="co">## klebs</span>


<span class="va">pairwise_within</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kleb.exists.x</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">kleb.exists.x</span>,
         <span class="va">kleb.poppunk.cluster.exists.x</span>,
         <span class="va">kleb.exists.y</span>,
         <span class="va">kleb.poppunk.cluster.exists.y</span>,
         <span class="va">delta_t</span>,
         <span class="va">snpdist_kleb</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_date.x</span>, <span class="va">data_date.y</span>,
                  <span class="va">kleb.exists.x</span>, <span class="va">kleb.exists.y</span>,
                  <span class="va">kleb.poppunk.cluster.exists.x</span>,
                  <span class="va">kleb.poppunk.cluster.exists.y</span>,
                  <span class="va">delta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#filter out those with an kleb but no poppunk cluster - they've not been</span>
  <span class="co"># sequenced</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="op">(</span><span class="va">kleb.exists.x</span> <span class="op">&amp;</span>
        <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.x</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">kleb.exists.y</span> <span class="op">&amp;</span>
        <span class="op">!</span><span class="va">kleb.poppunk.cluster.exists.y</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">kleb.long</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">newcolvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"snpdist_"</span>,<span class="va">i</span><span class="op">)</span>
  <span class="va">kleb.long</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">newcolvar</span><span class="op">}</span><span class="op">}</span> <span class="op">:=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span>
      <span class="va">value</span> <span class="op">&lt;=</span> <span class="va">i</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">kleb.long</span>
<span class="op">}</span>

<span class="va">kleb.long</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">delta_t</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"snpdist"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">delta_t</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>snpdist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"snpdist_"</span>,<span class="st">""</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">delta_t</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">snpdist</span>, group <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">150</span><span class="op">)</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.13</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.02</span>,<span class="fl">0.04</span>,<span class="fl">0.06</span>,<span class="fl">0.08</span>,<span class="fl">0.1</span>,<span class="fl">0.12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"SNP\ndistance"</span>,
       x <span class="op">=</span> <span class="st">"Time/days"</span>,
       y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b</span>

<span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">sens_analysis_within_snpdist</span>

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>

  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snpdist_autocorrelation.svg"</span><span class="op">)</span>,
         <span class="va">snp_networks</span>,
         width <span class="op">=</span> <span class="fl">9</span>,
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snpdist_autocorrelation.svg"</span><span class="op">)</span>,
         <span class="va">snp_networks</span>,
         width <span class="op">=</span> <span class="fl">9</span>, 
         height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R">


<span class="co">#### start plots -------------</span>

<span class="va">outlist.e.edges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.e.vertices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.e.plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.e.within_vs_betweendf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">outlist.k.edges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.k.vertices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.k.plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">outlist.k.within_vs_betweendf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">outlist.cluster_comm_vs_hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">listindex</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,<span class="fl">7</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">listindex</span> <span class="op">=</span> <span class="va">listindex</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hclust_snpdists.e</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hclust_snpdists.e</span>, h <span class="op">=</span> <span class="va">i</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cut_tree_vect.e</span>


  <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">hclust_snpdists.k</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hclust_snpdists.k</span>, h <span class="op">=</span> <span class="va">i</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cut_tree_vect.k</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
              lq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.25</span><span class="op">)</span>,
              uq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
              lq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.25</span><span class="op">)</span>,
              uq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>

  <span class="fu">make_all_clusters_pairwise_comparison_df</span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span>,
                                           <span class="va">btESBL_sequence_sample_metadata</span>,
                                           <span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairwise_snpclust.e</span>

  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    <span class="st">"snp_dist"</span> <span class="op">=</span> <span class="va">i</span>,
    <span class="st">"n_pairwise_snpclust_within"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span>
      <span class="va">pairwise_snpclust.e</span><span class="op">$</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pairwise_snpclust.e</span><span class="op">$</span><span class="va">pid.y</span>,
      na.rm <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    <span class="st">"n_pairwise_snpclust_total"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pairwise_snpclust.e</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">within_vs_between_pairwise_df.e</span>
             

  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
    <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span>,
                by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span> ,
                    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span>,
        by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>
      <span class="op">)</span>  <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lane.x</span> <span class="op">!=</span> <span class="va">lane.y</span>,
             <span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane.x</span>, <span class="va">lane.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Same Patient"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lane.x</span>,
             to <span class="op">=</span> <span class="va">lane.y</span><span class="op">)</span>,
    <span class="va">pairwise_snpclust.e</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample.x</span>, <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sample.x</span>,
             to <span class="op">=</span> <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"SNP cluster"</span><span class="op">)</span>

  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.e</span>




  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_esco</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      hosp_assoc <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"community"</span> <span class="op">~</span> <span class="st">"Community"</span>,
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span> <span class="op">~</span> <span class="st">"In hospital"</span>,
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"recent_dc"</span> <span class="op">~</span> <span class="st">"Post discharge"</span>
      <span class="op">)</span>,
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">lane</span>, .before <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
    <span class="va">vertices.e</span>

  <span class="va">edges.e</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sortvar <span class="op">=</span> <span class="fu">map2_chr</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="va">.x</span>, <span class="va">.y</span>
    <span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sortvar</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sortvar</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># remove those with missing metadata</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.e</span>


  <span class="va">gr.e</span> <span class="op">&lt;-</span>
    <span class="fu">graph_from_data_frame</span><span class="op">(</span><span class="va">edges.e</span>, directed <span class="op">=</span> <span class="cn">FALSE</span>, vertices <span class="op">=</span> <span class="va">vertices.e</span><span class="op">)</span>

  <span class="fu">ggraph</span><span class="op">(</span><span class="va">gr.e</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_edge_fan</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, width <span class="op">=</span>
                                                <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_node_point</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">hosp_assoc</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
    <span class="co">#  facet_edges(~ type) +</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
    <span class="va">snp_network_plot.esco</span>

  <span class="va">outlist.e.edges</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">edges.e</span>
  <span class="va">outlist.e.vertices</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vertices.e</span>
  <span class="va">outlist.e.plots</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">snp_network_plot.esco</span>
  <span class="va">outlist.e.within_vs_betweendf</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">within_vs_between_pairwise_df.e</span>



  <span class="co"># kleb</span>

  <span class="fu">make_all_clusters_pairwise_comparison_df</span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span>,
                                           <span class="va">btESBL_sequence_sample_metadata</span>,
                                           <span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairwise_snpclust.k</span>

    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    <span class="st">"snp_dist"</span> <span class="op">=</span> <span class="va">i</span>,
    <span class="st">"n_pairwise_snpclust_within"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span>
      <span class="va">pairwise_snpclust.k</span><span class="op">$</span><span class="va">pid.x</span> <span class="op">==</span> <span class="va">pairwise_snpclust.k</span><span class="op">$</span><span class="va">pid.y</span>,
      na.rm <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    <span class="st">"n_pairwise_snpclust_total"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pairwise_snpclust.k</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">within_vs_between_pairwise_df.k</span>

  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
    <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span>,
                by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">btESBL_sequence_sample_metadata</span>, <span class="va">lane</span>, <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span> ,
                    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span>,
        by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>
      <span class="op">)</span>  <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lane.x</span> <span class="op">!=</span> <span class="va">lane.y</span>,
             <span class="va">pid.x</span> <span class="op">==</span> <span class="va">pid.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">lane.x</span>, <span class="va">lane.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Same Patient"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lane.x</span>,
             to <span class="op">=</span> <span class="va">lane.y</span><span class="op">)</span>,
    <span class="va">pairwise_snpclust.k</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample.x</span>, <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sample.x</span>,
             to <span class="op">=</span> <span class="va">sample.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"SNP cluster"</span><span class="op">)</span>

  <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.k</span>




  <span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">btESBL_snpdists_kleb</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lane"</span> <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lane</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      hosp_assoc <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"community"</span> <span class="op">~</span> <span class="st">"Community"</span>,
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"in_hospital"</span> <span class="op">~</span> <span class="st">"In hospital"</span>,
        <span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"recent_dc"</span> <span class="op">~</span> <span class="st">"Post discharge"</span>
      <span class="op">)</span>,
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">lane</span>, .before <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span>
    <span class="va">vertices.k</span>

  <span class="va">edges.k</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sortvar <span class="op">=</span> <span class="fu">map2_chr</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="va">.x</span>, <span class="va">.y</span>
    <span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sortvar</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sortvar</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># remove those with missing metadata</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">vertices.k</span>,
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">vertices.k</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"lane"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">edges.k</span>


  <span class="va">gr.k</span> <span class="op">&lt;-</span>
    <span class="fu">graph_from_data_frame</span><span class="op">(</span><span class="va">edges.k</span>, directed <span class="op">=</span> <span class="cn">FALSE</span>, vertices <span class="op">=</span> <span class="va">vertices.k</span><span class="op">)</span>

  <span class="fu">ggraph</span><span class="op">(</span><span class="va">gr.k</span>, layout <span class="op">=</span> <span class="st">"fr"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_edge_fan</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, width <span class="op">=</span>
                                                <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_node_point</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">hosp_assoc</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
    <span class="co">#  facet_edges(~ type) +</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">-&gt;</span>
    <span class="va">snp_network_plot.kleb</span>

  <span class="va">outlist.k.edges</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">edges.k</span>
  <span class="va">outlist.k.vertices</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vertices.k</span>
  <span class="va">outlist.k.plots</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">snp_network_plot.kleb</span>
    <span class="va">outlist.k.within_vs_betweendf</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">within_vs_between_pairwise_df.k</span>

    
    <span class="co"># community vs not stats</span>
    
    
<span class="va">btESBL_sequence_sample_metadata</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_esco</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"esco"</span>,
    <span class="va">lane</span> <span class="op">%in%</span> <span class="va">btESBL_coregene_tree_kleb</span><span class="op">$</span><span class="va">tip.label</span>  <span class="op">~</span> <span class="st">"kleb"</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.e</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.e</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_member <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="st">"cluster_member"</span>, <span class="st">"cluster_nonmember"</span><span class="op">)</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lane <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cut_tree_vect.k</span><span class="op">)</span>,
                 clust_name <span class="op">=</span> <span class="va">cut_tree_vect.k</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">clust_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_member <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="st">"cluster_member"</span>, <span class="st">"cluster_nonmember"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"lane"</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_member <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">cluster_member</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">hosp_assoc</span>, <span class="va">cluster_member</span>, .drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">hosp_assoc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_member</span>, <span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
         snp_dist <span class="op">=</span> <span class="va">i</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cluster_member_comm_assoc_df</span>

<span class="va">outlist.cluster_comm_vs_hosp</span><span class="op">[[</span><span class="va">listindex</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cluster_member_comm_assoc_df</span>
    
<span class="op">}</span>
<span class="co">#&gt; [1] 0</span>
<span class="co">#&gt; [1] 3</span>
<span class="co">#&gt; [1] 7</span>
<span class="co">#&gt; [1] 10</span>

<span class="va">outlist.e.plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.e.plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.e.plots</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.e.plots</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">esco_snp_clusters_sens_analysis_plot</span>

<span class="va">outlist.k.plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.k.plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.k.plots</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="va">outlist.k.plots</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">kleb_snp_clusters_sens_analysis_plot</span>


<span class="va">esco_snp_clusters_sens_analysis_plot</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/snp-network-sens-analysis-1.png" alt="Sensitivity analysis of network plot of putative transmission clusters for E. coli, allowing the definition of a SNP-cluster to vary from 0 (A), to 3 (B), 7 (C), or 10 (D). Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by the given SNP threshold." width="1267.2"><p class="caption">
Sensitivity analysis of network plot of putative transmission clusters for E. coli, allowing the definition of a SNP-cluster to vary from 0 (A), to 3 (B), 7 (C), or 10 (D). Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by the given SNP threshold.
</p>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snp_networks_esco.pdf"</span><span class="op">)</span>,
         <span class="va">esco_snp_clusters_sens_analysis_plot</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>,
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snp_networks_esco.svg"</span><span class="op">)</span>,
         <span class="va">esco_snp_clusters_sens_analysis_plot</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>, 
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">kleb_snp_clusters_sens_analysis_plot</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/snp-network-sens-analysis_kleb-1.png" alt="Sensitivity analysis of network plot of putative transmission clusters for E. coli, allowing the definition of a SNP-cluster to vary from 0 (A), to 3 (B), 7 (C), or 10 (D). Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by the given SNP threshold." width="1267.2"><p class="caption">
Sensitivity analysis of network plot of putative transmission clusters for E. coli, allowing the definition of a SNP-cluster to vary from 0 (A), to 3 (B), 7 (C), or 10 (D). Points are samples, coloured by place of isolation (in-hospital [black], community [white], or up to 120 days post-discharge [grey]). Red lines link samples that are within a single participant. Blue lines link samples that are differ by the given SNP threshold.
</p>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snp_networks_kleb.pdf"</span><span class="op">)</span>,
         <span class="va">kleb_snp_clusters_sens_analysis_plot</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>,
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_sens_analysis_snp_networks_kleb.svg"</span><span class="op">)</span>,
         <span class="va">kleb_snp_clusters_sens_analysis_plot</span>,
         width <span class="op">=</span> <span class="fl">13.2</span>, 
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>### Model posterior pairs plot</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu">mcmc_pairs</span><span class="op">(</span><span class="va">btESBL_model2posterior</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alphas[1]"</span>, <span class="st">"betas[1]"</span>, <span class="st">"alphas[2]"</span>, <span class="st">"betas[2]"</span>, <span class="st">"lambda"</span>, <span class="st">"mu"</span>, <span class="st">"gammas[1]"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pairsplot</span>

<span class="va">pairsplot</span></code></pre></div>
<div class="figure">
<img src="analysis_files/figure-html/posterior-pairs-plot-1.png" alt="Pairs plots of posterior of final model showing nonidentifiability of gain and loss parameters." width="1152"><p class="caption">
Pairs plots of posterior of final model showing nonidentifiability of gain and loss parameters.
</p>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_pairsplot.pdf"</span><span class="op">)</span>,
         <span class="va">pairsplot</span>,
         width <span class="op">=</span> <span class="fl">12</span>,
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_pairsplot.svg"</span><span class="op">)</span>,
         <span class="va">pairsplot</span>,
         width <span class="op">=</span> <span class="fl">12</span>,
         height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="snp-cluster-comparisons-sensitivity-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#snp-cluster-comparisons-sensitivity-analysis" class="anchor"></a>SNP cluster comparisons sensitivity analysis</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">outlist.k.within_vs_betweendf</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">"K. pneumoniae"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">outlist.e.within_vs_betweendf</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">"E. coli"</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    prop <span class="op">=</span> <span class="va">n_pairwise_snpclust_within</span><span class="op">/</span><span class="va">n_pairwise_snpclust_total</span>,
    lci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n_pairwise_snpclust_within</span>, 
                     <span class="va">n_pairwise_snpclust_total</span><span class="op">)</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
    uci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n_pairwise_snpclust_within</span>, 
                     <span class="va">n_pairwise_snpclust_total</span><span class="op">)</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">within_vs_between</span>

<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>,<span class="va">outlist.cluster_comm_vs_hosp</span> <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hosp_assoc</span> <span class="op">==</span> <span class="st">"community"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="va">total</span>,
    lci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n</span>, 
                     <span class="va">total</span><span class="op">)</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
    uci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n</span>, 
                     <span class="va">total</span><span class="op">)</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">comm_vs_hosp</span>
  
<span class="va">within_vs_between</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">snp_dist</span>, <span class="va">prop</span>, ymin <span class="op">=</span> <span class="va">lci</span>, ymax <span class="op">=</span> <span class="va">uci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">species</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Proportion"</span>,
       x <span class="op">=</span> <span class="st">"SNP distance"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">a</span>

<span class="va">comm_vs_hosp</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> 
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"esco"</span> <span class="op">~</span> <span class="st">"E. coli"</span>,
                     <span class="va">species</span> <span class="op">==</span> <span class="st">"kleb"</span> <span class="op">~</span> <span class="st">"K. pneumoniae"</span><span class="op">)</span>,
         cluster_member <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"_"</span>,<span class="st">" "</span>,<span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">cluster_member</span><span class="op">)</span><span class="op">)</span>
         <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">snp_dist</span>, <span class="va">prop</span>, ymin <span class="op">=</span> <span class="va">lci</span>, ymax <span class="op">=</span> <span class="va">uci</span>, color <span class="op">=</span> <span class="va">cluster_member</span>, group <span class="op">=</span> <span class="va">cluster_member</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">species</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Proportion"</span>,
       x <span class="op">=</span> <span class="st">"SNP distance"</span>,
       color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b</span>
  
<span class="op">(</span><span class="va">a</span> <span class="op">/</span> <span class="va">b</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_level <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">sens.analysis.plot</span>

<span class="co">#5 x 6.5</span>

<span class="kw">if</span> <span class="op">(</span><span class="va">write_figs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_SNP_sens_ax_clusters.svg"</span><span class="op">)</span>,
         <span class="va">sens.analysis.plot</span>,
         width <span class="op">=</span> <span class="fl">6.5</span>,
         height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/long-modelling/SUPP_FIG_SNP_sens_ax_clusters.pdf"</span><span class="op">)</span>,
         <span class="va">sens.analysis.plot</span>,
         width <span class="op">=</span> <span class="fl">6.5</span>,
         height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="reproducibility-packages-used" class="section level3">
<h3 class="hasAnchor">
<a href="#reproducibility-packages-used" class="anchor"></a>Reproducibility: packages used</h3>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.1.1 (2021-08-10)</span>
<span class="co">#&gt; Platform: aarch64-apple-darwin20 (64-bit)</span>
<span class="co">#&gt; Running under: macOS Big Sur 11.6</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRblas.0.dylib</span>
<span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRlapack.dylib</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt; [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] blantyreESBL_1.0.0.0000 kableExtra_1.3.4        ggtree_3.0.4           </span>
<span class="co">#&gt;  [4] viridis_0.6.1           viridisLite_0.4.0       pheatmap_1.0.12        </span>
<span class="co">#&gt;  [7] ggplotify_0.1.0         loo_2.4.1               patchwork_1.1.1        </span>
<span class="co">#&gt; [10] bayesplot_1.8.1         ggsci_2.9               broom_0.7.9            </span>
<span class="co">#&gt; [13] glue_1.4.2              forcats_0.5.1           purrr_0.3.4            </span>
<span class="co">#&gt; [16] lubridate_1.7.10        stringr_1.4.0           tidyr_1.1.3            </span>
<span class="co">#&gt; [19] dplyr_1.0.7             ggraph_2.0.5            ggplot2_3.3.5          </span>
<span class="co">#&gt; [22] igraph_1.2.6            here_1.0.1             </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] colorspace_2.0-2     ellipsis_0.3.2       ggridges_0.5.3      </span>
<span class="co">#&gt;  [4] rprojroot_2.0.2      fs_1.5.0             aplot_0.0.6         </span>
<span class="co">#&gt;  [7] rstudioapi_0.13      farver_2.1.0         rstan_2.21.2        </span>
<span class="co">#&gt; [10] graphlayouts_0.7.1   ggrepel_0.9.1        fansi_0.5.0         </span>
<span class="co">#&gt; [13] xml2_1.3.2           splines_4.1.1        codetools_0.2-18    </span>
<span class="co">#&gt; [16] cachem_1.0.6         knitr_1.33           polyclip_1.10-0     </span>
<span class="co">#&gt; [19] jsonlite_1.7.2       ggforce_0.3.3        compiler_4.1.1      </span>
<span class="co">#&gt; [22] httr_1.4.2           backports_1.2.1      Matrix_1.3-4        </span>
<span class="co">#&gt; [25] assertthat_0.2.1     fastmap_1.1.0        lazyeval_0.2.2      </span>
<span class="co">#&gt; [28] cli_3.0.1            tweenr_1.0.2         htmltools_0.5.2     </span>
<span class="co">#&gt; [31] prettyunits_1.1.1    tools_4.1.1          gtable_0.3.0        </span>
<span class="co">#&gt; [34] reshape2_1.4.4       V8_3.4.2             Rcpp_1.0.7          </span>
<span class="co">#&gt; [37] jquerylib_0.1.4      pkgdown_1.6.1        vctrs_0.3.8         </span>
<span class="co">#&gt; [40] ape_5.5              svglite_2.0.0        nlme_3.1-152        </span>
<span class="co">#&gt; [43] xfun_0.25            ps_1.6.0             rvest_1.0.1         </span>
<span class="co">#&gt; [46] lifecycle_1.0.0      MASS_7.3-54          scales_1.1.1        </span>
<span class="co">#&gt; [49] tidygraph_1.2.0      ragg_1.1.3           parallel_4.1.1      </span>
<span class="co">#&gt; [52] inline_0.3.19        RColorBrewer_1.1-2   yaml_2.2.1          </span>
<span class="co">#&gt; [55] curl_4.3.2           memoise_2.0.0        gridExtra_2.3       </span>
<span class="co">#&gt; [58] ggfun_0.0.3          StanHeaders_2.21.0-7 yulab.utils_0.0.2   </span>
<span class="co">#&gt; [61] sass_0.4.0           stringi_1.7.4        highr_0.9           </span>
<span class="co">#&gt; [64] desc_1.3.0           tidytree_0.3.4       checkmate_2.0.0     </span>
<span class="co">#&gt; [67] pkgbuild_1.2.0       rlang_0.4.11         pkgconfig_2.0.3     </span>
<span class="co">#&gt; [70] systemfonts_1.0.2    matrixStats_0.60.1   evaluate_0.14       </span>
<span class="co">#&gt; [73] lattice_0.20-44      treeio_1.16.2        labeling_0.4.2      </span>
<span class="co">#&gt; [76] tidyselect_1.1.1     processx_3.5.2       plyr_1.8.6          </span>
<span class="co">#&gt; [79] magrittr_2.0.1       R6_2.5.1             generics_0.1.0      </span>
<span class="co">#&gt; [82] DBI_1.1.1            mgcv_1.8-36          pillar_1.6.2        </span>
<span class="co">#&gt; [85] withr_2.4.2          tibble_3.1.4         crayon_1.4.1        </span>
<span class="co">#&gt; [88] utf8_1.2.2           rmarkdown_2.10       grid_4.1.1          </span>
<span class="co">#&gt; [91] callr_3.7.0          digest_0.6.27        webshot_0.5.2       </span>
<span class="co">#&gt; [94] gridGraphics_0.5-1   textshaping_0.3.5    RcppParallel_5.1.4  </span>
<span class="co">#&gt; [97] stats4_4.1.1         munsell_0.5.0        bslib_0.2.5.1</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joseph Lewis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
